name: Scheduled Background Tasks

on:
  schedule:
    - cron: "*/15 * * * *"      # every 15 minutes (UTC)
    - cron: "1 0,6,12,18 * * *" # 00:01, 06:01, 12:01, 18:01 (UTC)
    - cron: "55 23 * * *"       # 23:55 (UTC)
  workflow_dispatch:            # allow manual run

jobs:
  every_15m:
    if: github.event_name == 'workflow_dispatch' || github.event.schedule == '*/15 * * * *'
    runs-on: ubuntu-latest
    steps:
      - name: Show current UTC time
        shell: bash
        run: |
          echo "Now     : $(date -u '+%Y-%m-%d %H:%M:%S')"
          echo "Event   : ${{ github.event_name }}"
          echo "Schedule: ${{ github.event.schedule }}"
      - name: Call 15m endpoint
        shell: bash
        env:
          CRON_TOKEN: ${{ secrets.CRON_TOKEN }}
          TASK_URL:   ${{ secrets.TASK_URL }}
        run: |
          curl -fsS -X POST -H "Authorization: Bearer $CRON_TOKEN" "${TASK_URL}?t=15m"

  every_6h:
    if: github.event_name == 'workflow_dispatch' || github.event.schedule == '1 0,6,12,18 * * *'
    runs-on: ubuntu-latest
    steps:
      - name: Show current UTC time
        shell: bash
        run: |
          echo "Now     : $(date -u '+%Y-%m-%d %H:%M:%S')"
          echo "Event   : ${{ github.event_name }}"
          echo "Schedule: ${{ github.event.schedule }}"
      - name: Call 6h endpoint
        shell: bash
        env:
          CRON_TOKEN: ${{ secrets.CRON_TOKEN }}
          TASK_URL:   ${{ secrets.TASK_URL }}
        run: |
          curl -fsS -X POST -H "Authorization: Bearer $CRON_TOKEN" "${TASK_URL}?t=6h"

  daily:
    if: github.event_name == 'workflow_dispatch' || github.event.schedule == '55 23 * * *'
    runs-on: ubuntu-latest
    steps:
      - name: Show current UTC time
        shell: bash
        run: |
          echo "Now     : $(date -u '+%Y-%m-%d %H:%M:%S')"
          echo "Event   : ${{ github.event_name }}"
          echo "Schedule: ${{ github.event.schedule }}"
      - name: Call daily endpoint
        shell: bash
        env:
          CRON_TOKEN: ${{ secrets.CRON_TOKEN }}
          TASK_URL:   ${{ secrets.TASK_URL }}
        run: |
          curl -fsS -X POST -H "Authorization: Bearer $CRON_TOKEN" "${TASK_URL}?t=daily"

