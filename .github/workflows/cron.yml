name: Scheduled Background Tasks
on:
  schedule:
    # Price updates every 15 minutes
    - cron: "*/15 * * * *"
    # Historical data collection every 15 minutes (offset by 5 minutes)
    - cron: "5,20,35,50 * * * *"
    # 6-hour jobs (weekly data) at 00:01, 06:01, 12:01, 18:01
    - cron: "1 0,6,12,18 * * *"
    # 12-hour jobs (monthly data) at 00:02 and 12:02
    - cron: "2 0,12 * * *"
    # Daily jobs at 23:55 UTC (handles cleanup, daily data, monthly tracker checks)
    - cron: "55 23 * * *"
  workflow_dispatch:  # Allow manual triggering

jobs:
  price-updates:
    runs-on: ubuntu-latest
    steps:
      - name: 15-minute price updates
        if: github.event.schedule == '*/15 * * * *'
        run: |
          curl -fsS -X POST \
            -H "Authorization: Bearer $CRON_TOKEN" \
            "${TASK_URL}?t=15m-prices" || echo "Price update failed"
        env: 
          CRON_TOKEN: ${{ secrets.CRON_TOKEN }}
          TASK_URL: ${{ secrets.TASK_URL }}

  historical-collection:
    runs-on: ubuntu-latest
    steps:
      - name: 15-minute historical data collection
        if: github.event.schedule == '5,20,35,50 * * * *'
        run: |
          curl -fsS -X POST \
            -H "Authorization: Bearer $CRON_TOKEN" \
            "${TASK_URL}?t=15m-historical" || echo "Historical collection failed"
        env: 
          CRON_TOKEN: ${{ secrets.CRON_TOKEN }}
          TASK_URL: ${{ secrets.TASK_URL }}

  hourly-jobs:
    runs-on: ubuntu-latest
    steps:
      - name: 6-hour jobs (weekly data)
        if: github.event.schedule == '1 0,6,12,18 * * *'
        run: |
          curl -fsS -X POST \
            -H "Authorization: Bearer $CRON_TOKEN" \
            "${TASK_URL}?t=6h" || echo "6-hour job failed"
        env: 
          CRON_TOKEN: ${{ secrets.CRON_TOKEN }}
          TASK_URL: ${{ secrets.TASK_URL }}

      - name: 12-hour jobs (monthly data)
        if: github.event.schedule == '2 0,12 * * *'
        run: |
          curl -fsS -X POST \
            -H "Authorization: Bearer $CRON_TOKEN" \
            "${TASK_URL}?t=12h" || echo "12-hour job failed"
        env: 
          CRON_TOKEN: ${{ secrets.CRON_TOKEN }}
          TASK_URL: ${{ secrets.TASK_URL }}

  daily-jobs:
    runs-on: ubuntu-latest
    steps:
      - name: Daily jobs (cleanup, daily data, tracker checks)
        if: github.event.schedule == '55 23 * * *'
        run: |
          curl -fsS -X POST \
            -H "Authorization: Bearer $CRON_TOKEN" \
            "${TASK_URL}?t=daily" || echo "Daily job failed"
        env: 
          CRON_TOKEN: ${{ secrets.CRON_TOKEN }}
          TASK_URL: ${{ secrets.TASK_URL }}

  manual-trigger:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    steps:
      - name: Manual trigger - run all tasks
        run: |
          echo "Running all tasks manually..."
          
          curl -fsS -X POST \
            -H "Authorization: Bearer $CRON_TOKEN" \
            "${TASK_URL}?t=15m-prices" || echo "Price update failed"
          
          sleep 10
          
          curl -fsS -X POST \
            -H "Authorization: Bearer $CRON_TOKEN" \
            "${TASK_URL}?t=15m-historical" || echo "Historical collection failed"
          
          sleep 10
          
          curl -fsS -X POST \
            -H "Authorization: Bearer $CRON_TOKEN" \
            "${TASK_URL}?t=6h" || echo "6-hour job failed"
          
          sleep 10
          
          curl -fsS -X POST \
            -H "Authorization: Bearer $CRON_TOKEN" \
            "${TASK_URL}?t=12h" || echo "12-hour job failed"
          
          sleep 10
          
          curl -fsS -X POST \
            -H "Authorization: Bearer $CRON_TOKEN" \
            "${TASK_URL}?t=daily" || echo "Daily job failed"
        env: 
          CRON_TOKEN: ${{ secrets.CRON_TOKEN }}
          TASK_URL: ${{ secrets.TASK_URL }}