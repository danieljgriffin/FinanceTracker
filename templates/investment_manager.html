{% extends "base.html" %}

{% block title %}Investment Manager - Net Worth Tracker{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4" style="overflow: visible;">
        <div class="flex-1" style="overflow: visible;">
            <h1 class="text-2xl sm:text-3xl lg:text-4xl font-bold text-white">Investment Portfolio</h1>
            <p class="text-white/80 mt-1 text-sm sm:text-base">Manage your actual investment holdings and their current values</p>
            <div class="text-xs sm:text-sm text-white/60 mt-2" id="price-status" style="overflow: visible;">
                {% if last_price_update %}
                    Prices refreshed: {{ last_price_update.strftime('%H:%M:%S') }}
                {% else %}
                    Prices: Loading...
                {% endif %}
            </div>
        </div>
        <div class="flex flex-col sm:flex-row gap-2 sm:gap-3 w-full sm:w-auto">
            <a href="{{ url_for('transaction_history') }}" class="flex-1 sm:flex-none px-4 sm:px-6 py-3 rounded-xl text-sm font-medium text-white transition-all duration-300 hover:transform hover:scale-105 text-center" style="background: linear-gradient(135deg, #6366f1, #4f46e5); box-shadow: 0 4px 16px rgba(99, 102, 241, 0.4);">
                <i class="fas fa-history mr-2"></i><span class="hidden sm:inline">History</span><span class="sm:hidden">Transaction History</span>
            </a>
            <a href="{{ url_for('update_prices') }}" class="flex-1 sm:flex-none px-4 sm:px-6 py-3 rounded-xl text-sm font-medium text-white transition-all duration-300 hover:transform hover:scale-105 text-center" style="background: linear-gradient(135deg, #10b981, #059669); box-shadow: 0 4px 16px rgba(16, 185, 129, 0.4);">
                <i class="fas fa-sync mr-2"></i><span class="hidden sm:inline">Update Prices</span><span class="sm:hidden">Update Prices</span>
            </a>
            <button onclick="showAddInvestmentModal()" class="flex-1 sm:flex-none px-4 sm:px-6 py-3 rounded-xl text-sm font-medium text-white transition-all duration-300 hover:transform hover:scale-105 text-center" style="background: linear-gradient(135deg, #3b82f6, #8b5cf6); box-shadow: 0 4px 16px rgba(59, 130, 246, 0.4);">
                <i class="fas fa-plus mr-2"></i><span class="hidden sm:inline">Add Investment</span><span class="sm:hidden">Add Investment</span>
            </button>
        </div>
    </div>

    <!-- Custom Modal Dialog -->
    <div id="modalOverlay" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="card max-w-2xl w-full">
                <div class="p-6">
                    <h3 id="modalTitle" class="text-lg font-semibold text-white mb-4"></h3>
                    <div id="modalContent" class="space-y-4"></div>
                    <div class="flex justify-end gap-3 mt-6">
                        <button onclick="closeModal()" class="px-4 py-2 rounded-lg bg-gray-600 text-white hover:bg-gray-700 transition-colors">
                            Cancel
                        </button>
                        <button id="modalSubmit" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition-colors">
                            Save
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Investment Platforms -->
    {% if investments_data %}
        <div class="space-y-6">
            {% for platform, investments in investments_data.items() %}
                {% if not platform.endswith('_cash') %}
                
                {% if platform == 'Cash' %}
                <!-- Special compact Cash section -->
                <div class="card overflow-hidden" style="display: block !important; opacity: 1 !important; visibility: visible !important;">
                    <div class="px-6 py-4" style="background-color: {{ platform_colors.get(platform, '#6b7280') }}20;">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="w-4 h-4 rounded-full mr-3" style="background-color: {{ platform_colors.get(platform, '#6b7280') }}"></div>
                                <h2 class="text-lg font-semibold text-white">{{ platform }}</h2>
                                <span class="ml-3 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-800 text-gray-300">
                                    Cash Holdings
                                </span>
                            </div>
                            <div class="text-right">
                                <div class="font-medium text-white financial-figure">£{{ "{:,.2f}".format(data_manager.get_platform_cash(platform)) }}</div>
                                <div class="text-sm text-gray-400">Current Balance</div>
                            </div>
                        </div>
                        
                        <!-- Cash update form -->
                        <div class="mt-4 pt-4 border-t border-gray-600/30">
                            <form method="POST" action="{{ url_for('update_cash', platform=platform) }}" class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <i class="fas fa-wallet text-gray-400"></i>
                                    <label class="text-sm font-medium text-white">Update Cash Balance:</label>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <div class="relative">
                                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">£</span>
                                        <input type="number" step="0.01" name="cash_amount" value="{{ data_manager.get_platform_cash(platform) }}" 
                                               class="w-32 pl-7 pr-3 py-2 text-sm border border-gray-600 bg-gray-800 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                                               placeholder="0.00">
                                    </div>
                                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white rounded-lg transition-all duration-300 hover:transform hover:scale-105" style="background: linear-gradient(135deg, {{ platform_colors.get(platform, '#6b7280') }}, {{ platform_colors.get(platform, '#6b7280') }}dd);">
                                        <i class="fas fa-save mr-1"></i>Update
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                {% else %}
                <!-- Regular investment platform section -->
                <div class="card overflow-hidden" style="display: block !important; opacity: 1 !important; visibility: visible !important;">
                    <div class="px-6 py-4 border-b border-gray-600/30" style="background-color: {{ platform_colors.get(platform, '#6b7280') }}20;">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="w-4 h-4 rounded-full mr-3" style="background-color: {{ platform_colors.get(platform, '#6b7280') }}"></div>
                                <h2 class="text-lg font-semibold text-white">{{ platform }}</h2>
                                <span class="ml-3 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-800 text-gray-300">
                                    {{ investments|length }} investment{{ 's' if investments|length != 1 else '' }}
                                </span>
                            </div>
                            <div class="text-right">
                                <div class="text-sm font-medium text-white">
                                    {% set platform_data = platform_totals.get(platform, {}) %}
                                    {% if platform_data and platform_data.get('total_value') %}
                                        <span class="financial-figure">£{{ "{:,.2f}".format(platform_data['total_value']) }}</span>
                                    {% else %}
                                        <span class="financial-figure">£0.00</span>
                                    {% endif %}
                                </div>
                                <div class="text-xs text-gray-400">
                                    Total Value (incl. cash)
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {% if investments %}
                        <div class="overflow-x-auto" style="display: block !important; opacity: 1 !important; visibility: visible !important;">
                            <table class="w-full" style="display: table !important; opacity: 1 !important; visibility: visible !important;">
                                <thead>
                                    <tr class="border-b border-gray-600/30">
                                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider">Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider">Current Price</th>
                                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider">Holdings</th>
                                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider">Current Value</th>
                                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider">Average Buy Price</th>
                                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider">Amount Spent</th>
                                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider">Percentage P/L</th>
                                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider">Total P/L</th>
                                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-600/30">
                                    {% for investment in investments %}
                                    {% set holdings = investment.get('holdings', 0) %}
                                    {% set current_price = investment.get('current_price', 0) %}
                                    {% set current_value = holdings * current_price %}
                                    {% set amount_spent = investment.get('amount_spent', 0) %}
                                    {% set total_pl = current_value - amount_spent %}
                                    {% set percentage_pl = (total_pl / amount_spent * 100) if amount_spent > 0 else 0 %}
                                    {% set average_buy_price = investment.get('average_buy_price', 0) %}
                                    
                                    <tr class="hover:bg-gray-800/30">
                                        <td class="px-6 py-4">
                                            <div class="flex items-center">
                                                <div class="text-sm font-medium text-white">{{ investment.name }}</div>
                                                {% if investment.get('symbol') %}
                                                    <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-900 text-blue-200">
                                                        {{ investment.symbol }}
                                                    </span>
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="text-sm text-white">
                                                {% if current_price > 0 %}
                                                    <span class="financial-figure">£{{ "{:,.4f}".format(current_price) }}</span>
                                                {% else %}
                                                    <span class="text-gray-400">No live price</span>
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="text-sm text-white">{{ "{:,.7f}".format(holdings) }}</div>
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="text-sm font-medium text-white">
                                                {% if current_value > 0 %}
                                                    <span class="financial-figure">£{{ "{:,.2f}".format(current_value) }}</span>
                                                {% else %}
                                                    <span class="text-gray-400">Update prices</span>
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="text-sm text-white financial-figure">£{{ "{:,.4f}".format(average_buy_price) }}</div>
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="text-sm text-white financial-figure">£{{ "{:,.2f}".format(amount_spent) }}</div>
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="text-sm font-medium {{ 'text-green-400' if percentage_pl > 0 else 'text-red-400' if percentage_pl < 0 else 'text-white' }}">
                                                {% if current_value > 0 %}
                                                    {{ "{:+.2f}".format(percentage_pl) }}%
                                                {% else %}
                                                    <span class="text-gray-400">-</span>
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="text-sm font-medium {{ 'text-green-400' if total_pl > 0 else 'text-red-400' if total_pl < 0 else 'text-white' }}">
                                                {% if current_value > 0 %}
                                                    <span class="financial-figure">{# No £ symbol in Total P/L #}{{ "{:+,.2f}".format(total_pl) }}</span>
                                                {% else %}
                                                    <span class="text-gray-400">-</span>
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="flex items-center space-x-2">
                                                <button onclick="editInvestment('{{ platform }}', {{ investment.id }})" class="text-gray-400 hover:text-blue-400 transition-colors">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button onclick="deleteInvestment('{{ platform }}', {{ investment.id }}, '{{ investment.name }}')" class="text-gray-400 hover:text-red-400 transition-colors">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                    
                                    <!-- Platform Totals Row -->
                                    {% if investments and platform_totals.get(platform) %}
                                    {% set platform_data = platform_totals.get(platform) %}
                                    <tr class="border-t-2 border-gray-600/50 bg-gray-800/50">
                                        <td class="px-6 py-4">
                                            <div class="text-sm font-bold text-white">Total</div>
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="text-sm text-gray-400">-</div>
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="text-sm text-gray-400">-</div>
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="text-sm font-bold text-white financial-figure">£{{ "{:,.2f}".format(platform_data['investment_value']) }}</div>
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="text-sm text-gray-400">-</div>
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="text-sm font-bold text-white financial-figure">£{{ "{:,.2f}".format(platform_data['amount_spent']) }}</div>
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="text-sm font-bold {{ 'text-green-400' if platform_data['percentage_pl'] > 0 else 'text-red-400' if platform_data['percentage_pl'] < 0 else 'text-white' }}">
                                                {{ "{:+.2f}".format(platform_data['percentage_pl']) }}%
                                            </div>
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="text-sm font-bold {{ 'text-green-400' if platform_data['total_pl'] > 0 else 'text-red-400' if platform_data['total_pl'] < 0 else 'text-white' }}">
                                                <span class="financial-figure">{{ "{:+,.2f}".format(platform_data['total_pl']) }}</span>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="text-sm text-gray-400">-</div>
                                        </td>
                                    </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="px-6 py-8 text-center">
                            <i class="fas fa-plus-circle text-gray-400 text-3xl mb-3"></i>
                            <p class="text-gray-300">No investments in this platform</p>
                            <p class="text-sm text-gray-400">Add your first investment to get started</p>
                        </div>
                    {% endif %}
                    
                    <!-- Cash Balance Section for regular platforms -->
                    <div class="px-6 py-4 bg-gray-800/50 border-t border-gray-600/30">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fas fa-wallet text-gray-400 mr-2"></i>
                                <span class="text-sm font-medium text-white">Cash Balance:</span>
                                <span class="ml-2 text-sm font-semibold text-white">£{{ "{:,.2f}".format(data_manager.get_platform_cash(platform)) }}</span>
                            </div>
                            <form method="POST" action="{{ url_for('update_cash', platform=platform) }}" class="flex items-center space-x-2">
                                <input type="number" step="0.01" name="cash_amount" value="{{ data_manager.get_platform_cash(platform) }}" 
                                       class="w-24 px-2 py-1 text-sm border border-gray-600 bg-gray-800 text-white rounded focus:outline-none focus:ring-1 focus:ring-blue-500" 
                                       placeholder="0.00">
                                <button type="submit" class="px-3 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors">
                                    Update
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                {% endif %}
                {% endif %}
            {% endfor %}
        </div>
    {% endif %}

    <!-- Summary Statistics -->
    <div class="card">
        <div class="px-8 py-6 border-b border-gray-600/30">
            <h2 class="text-xl font-semibold text-white">Investment Summary</h2>
        </div>
        <div class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="text-center">
                    <div class="text-2xl font-bold text-white financial-figure">£{{ "{:,.2f}".format(total_portfolio_value) }}</div>
                    <div class="text-sm text-gray-400">Total Portfolio Value</div>
                </div>
                
                <div class="text-center">
                    <div class="text-2xl font-bold text-white financial-figure">£{{ "{:,.2f}".format(total_amount_spent) }}</div>
                    <div class="text-sm text-gray-400">Total Amount Spent</div>
                </div>
                
                <div class="text-center">
                    <div class="text-2xl font-bold {{ 'text-green-400' if total_portfolio_percentage_pl > 0 else 'text-red-400' if total_portfolio_percentage_pl < 0 else 'text-white' }}">
                        {{ "{:+.2f}".format(total_portfolio_percentage_pl) }}%
                    </div>
                    <div class="text-sm text-gray-400">Percentage Profit/Loss</div>
                </div>
                
                <div class="text-center">
                    <div class="text-2xl font-bold {{ 'text-green-400' if total_portfolio_pl > 0 else 'text-red-400' if total_portfolio_pl < 0 else 'text-white' }}">
                        <span class="financial-figure">£{{ "{:+,.2f}".format(total_portfolio_pl) }}</span>
                    </div>
                    <div class="text-sm text-gray-400">Total Profit/Loss</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Platform Distribution -->
    <div class="card">
        <div class="px-8 py-6 border-b border-gray-600/30">
            <h2 class="text-xl font-semibold text-white">Platform Distribution</h2>
        </div>
        <div class="p-6">
            <div class="space-y-4">
                {% for platform, investments in investments_data.items() %}
                    {% if not platform.endswith('_cash') %}
                        {% set platform_data = platform_totals.get(platform, {}) %}
                        {% set platform_total_value = platform_data.get('total_value', 0) %}
                        {% if platform_total_value > 0 %}
                            {% set percentage = (platform_total_value / total_portfolio_value * 100) if total_portfolio_value > 0 else 0 %}
                            
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="w-4 h-4 rounded-full mr-3" style="background-color: {{ platform_colors.get(platform, '#6b7280') }}"></div>
                                    <span class="font-medium text-white">{{ platform }}</span>
                                </div>
                                <div class="text-right">
                                    <div class="font-medium text-white financial-figure">£{{ "{:,.2f}".format(platform_total_value) }}</div>
                                    <div class="text-sm text-gray-400">{{ "{:.1f}".format(percentage) }}%</div>
                                </div>
                            </div>
                            <div class="w-full bg-gray-700 rounded-full h-2">
                                <div class="h-2 rounded-full transition-all duration-300" 
                                     style="width: {{ percentage }}%; background-color: {{ platform_colors.get(platform, '#6b7280') }}"></div>
                            </div>
                        {% endif %}
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
function showAddInvestmentModal() {
    const platforms = Object.keys({{ platform_colors|tojson }});
    const platformOptions = platforms.map(p => `<option value="${p}">${p}</option>`).join('');
    const investmentNames = {{ platform_investment_names|tojson }};
    
    document.getElementById('modalTitle').textContent = 'Add New Investment';
    document.getElementById('modalContent').innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium text-white mb-2">Platform</label>
                <select id="investmentPlatform" onchange="updateInvestmentNameOptions()" class="w-full border border-gray-600 bg-gray-800 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    ${platformOptions}
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-white mb-2">Investment Name</label>
                <input type="text" id="investmentName" list="investmentNameOptions" class="w-full border border-gray-600 bg-gray-800 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Tesla Stock or ETH" required>
                <datalist id="investmentNameOptions">
                    <!-- Will be populated by updateInvestmentNameOptions() -->
                </datalist>
            </div>
            <div>
                <label class="block text-sm font-medium text-white mb-2">Holdings (Quantity)</label>
                <input type="number" step="any" id="investmentHoldings" class="w-full border border-gray-600 bg-gray-800 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., 15.5521236" required>
            </div>
            <div>
                <label class="block text-sm font-medium text-white mb-2">Input Type</label>
                <select id="inputType" onchange="toggleModalInputType()" class="w-full border border-gray-600 bg-gray-800 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="amount_spent">Amount Spent</option>
                    <option value="average_buy_price">Average Buy Price</option>
                </select>
            </div>
            <div id="amountSpentInput">
                <label class="block text-sm font-medium text-white mb-2">Amount Spent (£)</label>
                <input type="number" step="0.01" id="amountSpent" class="w-full border border-gray-600 bg-gray-800 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="0.00">
            </div>
            <div id="averageBuyPriceInput" style="display: none;">
                <label class="block text-sm font-medium text-white mb-2">Average Buy Price (£)</label>
                <input type="number" step="any" id="averageBuyPrice" class="w-full border border-gray-600 bg-gray-800 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="0.0000">
            </div>
            <div class="md:col-span-2">
                <label class="block text-sm font-medium text-white mb-2">Symbol (Optional)</label>
                <input type="text" id="investmentSymbol" class="w-full border border-gray-600 bg-gray-800 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., TSLA, BTC-USD">
            </div>
        </div>
    `;
    
    // Initialize with first platform's options
    updateInvestmentNameOptions();
    
    document.getElementById('modalSubmit').onclick = function() {
        const platform = document.getElementById('investmentPlatform').value;
        const name = document.getElementById('investmentName').value.trim();
        const holdings = parseFloat(document.getElementById('investmentHoldings').value);
        const inputType = document.getElementById('inputType').value;
        const amountSpent = parseFloat(document.getElementById('amountSpent').value) || 0;
        const averageBuyPrice = parseFloat(document.getElementById('averageBuyPrice').value) || 0;
        const symbol = document.getElementById('investmentSymbol').value.trim();
        
        if (name && !isNaN(holdings) && holdings > 0) {
            // Create form data
            const formData = new FormData();
            formData.append('platform', platform);
            formData.append('name', name);
            formData.append('holdings', holdings);
            formData.append('input_type', inputType);
            formData.append('amount_spent', amountSpent);
            formData.append('average_buy_price', averageBuyPrice);
            formData.append('symbol', symbol);
            
            // Submit the form
            fetch('/add-investment', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Error adding investment');
                }
            });
            
            closeModal();
        } else {
            alert('Please fill in all required fields with valid values.');
        }
    };
    
    document.getElementById('modalOverlay').classList.remove('hidden');
}

function toggleModalInputType() {
    const inputType = document.getElementById('inputType').value;
    const amountSpentInput = document.getElementById('amountSpentInput');
    const averageBuyPriceInput = document.getElementById('averageBuyPriceInput');
    
    if (inputType === 'amount_spent') {
        amountSpentInput.style.display = 'block';
        averageBuyPriceInput.style.display = 'none';
    } else {
        amountSpentInput.style.display = 'none';
        averageBuyPriceInput.style.display = 'block';
    }
}

function editInvestment(platform, investmentId) {
    // Get investment data from the page
    const investments = {{ investments_data|tojson }};
    
    // Find the investment by ID
    let investment = null;
    for (const inv of investments[platform]) {
        if (inv.id === investmentId) {
            investment = inv;
            break;
        }
    }
    
    if (!investment) {
        alert('Investment not found');
        return;
    }
    
    const platforms = Object.keys({{ platform_colors|tojson }});
    const platformOptions = platforms.map(p => `<option value="${p}" ${p === platform ? 'selected' : ''}>${p}</option>`).join('');
    
    document.getElementById('modalTitle').textContent = 'Edit Investment';
    document.getElementById('modalContent').innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium text-white mb-2">Platform</label>
                <select id="investmentPlatform" class="w-full border border-gray-600 bg-gray-800 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    ${platformOptions}
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-white mb-2">Investment Name</label>
                <input type="text" id="investmentName" value="${investment.name}" class="w-full border border-gray-600 bg-gray-800 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>
            <div>
                <label class="block text-sm font-medium text-white mb-2">Holdings (Quantity)</label>
                <input type="number" step="any" id="investmentHoldings" value="${investment.holdings}" class="w-full border border-gray-600 bg-gray-800 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>
            <div>
                <label class="block text-sm font-medium text-white mb-2">Input Type</label>
                <select id="inputType" onchange="toggleModalInputType()" class="w-full border border-gray-600 bg-gray-800 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="amount_spent">Amount Spent</option>
                    <option value="average_buy_price">Average Buy Price</option>
                </select>
            </div>
            <div id="amountSpentInput">
                <label class="block text-sm font-medium text-white mb-2">Amount Spent (£)</label>
                <input type="number" step="0.01" id="amountSpent" value="${investment.amount_spent || 0}" class="w-full border border-gray-600 bg-gray-800 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div id="averageBuyPriceInput" style="display: none;">
                <label class="block text-sm font-medium text-white mb-2">Average Buy Price (£)</label>
                <input type="number" step="any" id="averageBuyPrice" value="${investment.average_buy_price || 0}" class="w-full border border-gray-600 bg-gray-800 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="md:col-span-2">
                <label class="block text-sm font-medium text-white mb-2">Symbol (Optional)</label>
                <input type="text" id="investmentSymbol" value="${investment.symbol || ''}" class="w-full border border-gray-600 bg-gray-800 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
        </div>
    `;
    
    document.getElementById('modalSubmit').onclick = function() {
        const newPlatform = document.getElementById('investmentPlatform').value;
        const name = document.getElementById('investmentName').value.trim();
        const holdings = parseFloat(document.getElementById('investmentHoldings').value);
        const inputType = document.getElementById('inputType').value;
        const amountSpent = parseFloat(document.getElementById('amountSpent').value) || 0;
        const averageBuyPrice = parseFloat(document.getElementById('averageBuyPrice').value) || 0;
        const symbol = document.getElementById('investmentSymbol').value.trim();
        
        console.log('Updating investment:', {platform, investmentId, name, holdings, inputType, amountSpent, averageBuyPrice, symbol});
        
        if (name && !isNaN(holdings) && holdings > 0) {
            // Create form data
            const formData = new FormData();
            formData.append('platform', newPlatform);
            formData.append('name', name);
            formData.append('holdings', holdings);
            formData.append('input_type', inputType);
            formData.append('amount_spent', amountSpent);
            formData.append('average_buy_price', averageBuyPrice);
            formData.append('symbol', symbol);
            
            // Submit the form
            fetch(`/update-investment/${platform}/${investmentId}`, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                console.log('Update response status:', response.status);
                if (response.ok) {
                    location.reload();
                } else {
                    response.text().then(text => {
                        console.error('Update failed:', text);
                        alert('Error updating investment: ' + response.status);
                    });
                }
            })
            .catch(error => {
                console.error('Update error:', error);
                alert('Error updating investment: ' + error.message);
            });
            
            closeModal();
        } else {
            alert('Please fill in all required fields with valid values.');
        }
    };
    
    document.getElementById('modalOverlay').classList.remove('hidden');
}

function deleteInvestment(platform, investmentId, name) {
    if (confirm(`Are you sure you want to delete "${name}" from ${platform}?`)) {
        // Create a form and submit it
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/delete-investment/${platform}/${investmentId}`;
        document.body.appendChild(form);
        form.submit();
    }
}

function closeModal() {
    document.getElementById('modalOverlay').classList.add('hidden');
}

// Close modal when clicking outside
document.getElementById('modalOverlay').onclick = function(e) {
    if (e.target === this) {
        closeModal();
    }
};

// Auto-refresh price status every 30 seconds
function updatePriceStatus() {
    fetch('/api/price-status')
        .then(response => response.json())
        .then(data => {
            const statusElement = document.getElementById('price-status');
            if (data.last_updated) {
                // API returns time string directly (e.g., "17:49:25")
                const timeString = data.last_updated;
                statusElement.innerHTML = `Prices refreshed: ${timeString} (auto-refresh every 15m)`;
            } else {
                statusElement.innerHTML = 'Prices: Loading...';
            }
        })
        .catch(error => {
            console.error('Error fetching price status:', error);
        });
}

// Update price status every 30 seconds
setInterval(updatePriceStatus, 30000);

// Initial update
updatePriceStatus();

// Function to update investment name options based on selected platform
function updateInvestmentNameOptions() {
    const platform = document.getElementById('investmentPlatform').value;
    const investmentNames = {{ platform_investment_names|tojson }};
    const datalist = document.getElementById('investmentNameOptions');
    
    if (datalist && investmentNames && investmentNames[platform]) {
        datalist.innerHTML = '';
        investmentNames[platform].forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            datalist.appendChild(option);
        });
    }
}
</script>
{% endblock %}
