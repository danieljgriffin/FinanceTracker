<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio - Net Worth Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body {
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a1a 100%);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .trading-card {
            background: rgba(20, 20, 20, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .bottom-nav {
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .nav-icon {
            transition: all 0.2s ease;
        }
        
        .nav-icon.active {
            color: #00d4ff !important;
        }
        

    </style>
</head>
<body class="bg-black text-white min-h-screen">
    
    <!-- Main Content -->
    <div class="pb-20">
        <!-- Header -->
        <div class="flex items-center justify-between p-4">
            <div>
                <h1 class="text-white text-lg font-semibold">Portfolio</h1>
            </div>
        </div>
        
        <!-- Portfolio Value -->
        <div class="px-4 mb-6">
            <div class="mb-4">
                <span class="text-3xl font-bold text-white">£{{ "{:,.2f}".format(current_net_worth) }}</span>
            </div>
            
            <!-- Monthly and Yearly Stats -->
            <div class="flex space-x-8 mb-2">
                <div>
                    <span class="text-gray-400 text-xs uppercase tracking-wide">MONTHLY</span>
                    <div class="flex items-center space-x-1">
                        <span class="text-{% if mom_change >= 0 %}green{% else %}red{% endif %}-400 font-semibold text-sm">
                            {% if mom_change >= 0 %}+{% endif %}£{{ "{:,.0f}".format(mom_amount_change) }}
                        </span>
                        <span class="text-{% if mom_change >= 0 %}green{% else %}red{% endif %}-400 text-xs">
                            ({% if mom_change >= 0 %}+{% endif %}{{ "{:.1f}".format(mom_change) }}%)
                        </span>
                    </div>
                </div>
                <div>
                    <span class="text-gray-400 text-xs uppercase tracking-wide">YEARLY</span>
                    <div class="flex items-center space-x-1">
                        <span class="text-{% if yoy_amount_change >= 0 %}green{% else %}red{% endif %}-400 font-semibold text-sm">
                            {% if yoy_amount_change >= 0 %}+{% endif %}£{{ "{:,.0f}".format(yoy_amount_change) }}
                        </span>
                        <span class="text-{% if yoy_amount_change >= 0 %}green{% else %}red{% endif %}-400 text-xs">
                            ({% if yoy_amount_change >= 0 %}+{% endif %}{{ "{:.1f}".format(yoy_percentage_change) }}%)
                        </span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Full Width Chart -->
        <div class="mb-6">
            <div class="h-64 w-full relative">
                <svg viewBox="0 0 400 256" class="w-full h-full" id="portfolioChart">
                    <!-- Chart elements will be dynamically updated -->
                </svg>
                
                <!-- Interactive overlay for touch/hover - aligned with chart data points -->
                <div id="chartOverlay" class="absolute inset-0 bg-transparent cursor-pointer"
                     onmousedown="startInteraction(event)"
                     onmousemove="updateHoverPosition(event)"
                     onmouseup="endInteraction()"
                     onmouseleave="endInteraction()"
                     ontouchstart="startInteraction(event)"
                     ontouchmove="updateHoverPosition(event)"
                     ontouchend="endInteraction()"></div>
                
                <!-- Hover indicator line and value display -->
                <div id="hoverIndicator" class="absolute pointer-events-none opacity-0 transition-opacity duration-200">
                    <div class="w-px h-full bg-white bg-opacity-50"></div>
                </div>
                
                <!-- Value tooltip -->
                <div id="valueTooltip" class="absolute pointer-events-none opacity-0 transition-opacity duration-200 bg-black bg-opacity-75 text-white text-xs px-2 py-1 rounded backdrop-blur-sm">
                    <div id="tooltipValue"></div>
                    <div id="tooltipDate" class="text-gray-300"></div>
                </div>
            </div>
            
            <!-- Time Range Options -->
            <div class="flex justify-center space-x-6 mt-3 px-4">
                <span class="text-gray-400 text-sm cursor-pointer hover:text-white transition-colors" onclick="updateChart('2023')">2023</span>
                <span class="text-gray-400 text-sm cursor-pointer hover:text-white transition-colors" onclick="updateChart('2024')">2024</span>
                <span class="text-gray-400 text-sm cursor-pointer hover:text-white transition-colors" onclick="updateChart('2025')">2025</span>
                <span class="text-white text-sm font-semibold cursor-pointer" id="activeRange">MAX</span>
            </div>
        </div>
        
        <!-- Section Tabs -->
        <div class="px-4 mb-4">
            <div class="flex">
                <button class="flex-1 py-3 text-center text-white border-b-2 border-blue-400">
                    <span class="font-medium">Net Worth Breakdown</span>
                </button>
            </div>
        </div>
        

        
        <!-- Investment List -->
        <div class="px-4 space-y-3">
            {% for platform, amount in platform_allocations.items() %}
            <div class="flex items-center justify-between py-3">
                <div class="flex items-center space-x-3">
                    <!-- Platform Icon -->
                    <div class="w-10 h-10 rounded-lg flex items-center justify-center" 
                         style="background-color: {{ platform_colors[platform] }}">
                        <!-- Keep the colored icon background only -->
                    </div>
                    
                    <!-- Platform Info -->
                    <div>
                        <div class="text-white font-medium">{{ platform }}</div>
                        <div class="text-gray-400 text-sm">{{ "{:.1f}".format(platform_percentages.get(platform, 0)) }}% of portfolio</div>
                    </div>
                </div>
                
                <!-- Value and Change -->
                <div class="text-right">
                    <div class="text-white font-semibold">£{{ "{:,.2f}".format(amount) }}</div>
                    {% set platform_change = platform_monthly_changes.get(platform, {'amount': 0, 'percent': 0}) %}
                    <div class="text-{% if platform_change.amount >= 0 %}green{% else %}red{% endif %}-400 text-sm">
                        {% if platform_change.amount >= 0 %}+{% endif %}£{{ "{:,.0f}".format(platform_change.amount) }}
                        ({% if platform_change.percent >= 0 %}+{% endif %}{{ "{:.2f}".format(platform_change.percent) }}%)
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Bottom Navigation -->
    <div class="fixed bottom-0 left-0 right-0 bottom-nav">
        <div class="flex justify-around items-center py-2">
            <a href="#" class="flex flex-col items-center py-2 nav-icon active">
                <i class="fas fa-home text-lg mb-1"></i>
                <span class="text-xs">Home</span>
            </a>
            <a href="#" class="flex flex-col items-center py-2 nav-icon text-gray-400">
                <i class="fas fa-briefcase text-lg mb-1"></i>
                <span class="text-xs">Investments</span>
            </a>
            <a href="#" class="flex flex-col items-center py-2 nav-icon text-gray-400">
                <i class="fas fa-calendar-alt text-lg mb-1"></i>
                <span class="text-xs">Tracker</span>
            </a>
            <a href="#" class="flex flex-col items-center py-2 nav-icon text-gray-400">
                <i class="fas fa-target text-lg mb-1"></i>
                <span class="text-xs">Goals</span>
            </a>
            <a href="#" class="flex flex-col items-center py-2 nav-icon text-gray-400">
                <i class="fas fa-chart-bar text-lg mb-1"></i>
                <span class="text-xs">Breakdown</span>
            </a>
        </div>
    </div>
    
    <script>
        // Use real chart data from server
        const chartData = {{ chart_data | tojson | safe }};

        let currentRange = 'MAX';
        let currentChartData = null;
        let isInteracting = false;

        function updateChart(range) {
            if (range === currentRange) return;
            
            const svg = document.getElementById('portfolioChart');
            const data = chartData[range];
            
            // Update active range styling
            document.querySelectorAll('[onclick^="updateChart"]').forEach(el => {
                el.className = 'text-gray-400 text-sm cursor-pointer hover:text-white transition-colors';
            });
            
            if (range === 'MAX') {
                document.getElementById('activeRange').className = 'text-white text-sm font-semibold cursor-pointer';
                document.getElementById('activeRange').textContent = 'MAX';
            } else {
                event.target.className = 'text-white text-sm font-semibold cursor-pointer';
                document.getElementById('activeRange').className = 'text-gray-400 text-sm cursor-pointer hover:text-white transition-colors';
                document.getElementById('activeRange').onclick = () => updateChart('MAX');
            }
            
            // Update chart
            const hasCurrentValue = data.hasCurrentValue || false;
            const linePoints = data.line.split(' ');
            const lastPoint = linePoints[linePoints.length - 1];
            
            // Create dots for each data point
            const dataPoints = linePoints.map(point => {
                const [x, y] = point.split(',');
                return `<circle cx="${x}" cy="${y}" r="3" fill="#00d4ff" stroke="#1a1a1a" stroke-width="1"/>`;
            }).join('');
            
            // Mark current value point differently if it exists
            const currentPointMarkup = hasCurrentValue && lastPoint ? 
                `<circle cx="${lastPoint.split(',')[0]}" cy="${lastPoint.split(',')[1]}" r="5" fill="#00d4ff" stroke="#ffffff" stroke-width="2"/>` : '';
            
            svg.innerHTML = `
                <polyline fill="none" stroke="#00d4ff" stroke-width="2" points="${data.line}"/>
                ${dataPoints}
                ${currentPointMarkup}
                ${data.yLabels.map(label => 
                    `<text x="385" y="${label.y}" font-size="11" fill="#9ca3af" text-anchor="end">${label.text}</text>`
                ).join('')}
                ${data.xLabels.map(label => 
                    `<text x="${label.x}" y="240" font-size="10" fill="${label.text.includes('*') ? '#00d4ff' : '#6b7280'}" text-anchor="middle">${label.text}</text>`
                ).join('')}
            `;
            
            currentRange = range;
            currentChartData = data;
            
            // Store actual data points for precise hover detection
            const points = data.line.split(' ').map((point, index) => {
                const [x, y] = point.split(',').map(Number);
                return {
                    x: x,
                    y: y,
                    label: data.xLabels[index]?.text || '',
                    index: index
                };
            });
            currentChartData.dataPoints = points;
            currentChartData.hasCurrentValue = data.hasCurrentValue;
            
            setupChartInteraction();
        }

        function setupChartInteraction() {
            const overlay = document.getElementById('chartOverlay');
            const indicator = document.getElementById('hoverIndicator');
            const tooltip = document.getElementById('valueTooltip');
            const chartContainer = overlay.parentElement;
            
            // Touch and mouse events
            overlay.addEventListener('touchstart', handleInteractionStart);
            overlay.addEventListener('mousedown', handleInteractionStart);
            overlay.addEventListener('touchmove', handleInteractionMove);
            overlay.addEventListener('mousemove', handleInteractionMove);
            overlay.addEventListener('touchend', handleInteractionEnd);
            overlay.addEventListener('mouseup', handleInteractionEnd);
            overlay.addEventListener('mouseleave', handleInteractionEnd);
            
            function handleInteractionStart(e) {
                e.preventDefault();
                isInteracting = true;
                indicator.style.opacity = '1';
                tooltip.style.opacity = '1';
                updateHoverPosition(e);
            }
            
            function handleInteractionMove(e) {
                if (!isInteracting) return;
                e.preventDefault();
                updateHoverPosition(e);
            }
            
            function handleInteractionEnd(e) {
                e.preventDefault();
                isInteracting = false;
                indicator.style.opacity = '0';
                tooltip.style.opacity = '0';
            }
            
            function updateHoverPosition(e) {
                if (!currentChartData || !isInteracting) return;
                
                const rect = overlay.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const x = clientX - rect.left;
                
                // Find closest data point by actual screen distance to dots
                const closestPoint = findClosestPointByScreenDistance(x, rect.width);
                
                if (closestPoint) {
                    // Position indicator at exact dot position
                    const snapX = ((closestPoint.x - 20) / 320) * rect.width;
                    indicator.style.left = `${snapX}px`;
                    
                    // Get value for this specific point
                    const value = interpolateValue(closestPoint.x);
                    const dateInfo = closestPoint.label;
                    
                    if (value !== null && dateInfo) {
                        document.getElementById('tooltipValue').textContent = `£${(value/1000).toFixed(0)}k`;
                        document.getElementById('tooltipDate').textContent = dateInfo.includes('*') ? dateInfo : `1st ${dateInfo}`;
                        tooltip.style.opacity = '1';
                        
                        // Position tooltip at snapped position
                        const tooltipX = Math.max(0, Math.min(rect.width - 80, snapX - 40));
                        tooltip.style.left = `${tooltipX}px`;
                        tooltip.style.top = '10px';
                    } else {
                        tooltip.style.opacity = '0';
                    }
                } else {
                    tooltip.style.opacity = '0';
                }
            }
            
            function findClosestPointByScreenDistance(touchX, overlayWidth) {
                if (!currentChartData || !currentChartData.dataPoints) return null;
                
                const points = currentChartData.dataPoints;
                if (points.length === 0) return null;
                
                let closestPoint = null;
                let minScreenDistance = Infinity;
                
                for (const point of points) {
                    // Convert SVG coordinate to screen coordinate
                    const screenX = ((point.x - 20) / 320) * overlayWidth;
                    const distance = Math.abs(touchX - screenX);
                    
                    if (distance < minScreenDistance) {
                        minScreenDistance = distance;
                        closestPoint = point;
                    }
                }
                
                // Return closest point if within reasonable touch distance (50px)
                return minScreenDistance <= 50 ? closestPoint : null;
            }
            
            function getClosestDataPoint(chartX) {
                if (!currentChartData || !currentChartData.dataPoints) return null;
                
                const points = currentChartData.dataPoints;
                if (points.length === 0) return null;
                
                // Find the closest actual data point
                let closestPoint = points[0];
                let minDistance = Math.abs(chartX - points[0].x);
                
                for (const point of points) {
                    const distance = Math.abs(chartX - point.x);
                    if (distance < minDistance) {
                        minDistance = distance;
                        closestPoint = point;
                    }
                }
                
                // Increase snap range for easier touch interaction (within 40px)
                if (minDistance > 40) return null;
                
                return closestPoint;
            }
            
            function interpolateValue(chartX) {
                const closestPoint = getClosestDataPoint(chartX);
                if (!closestPoint) return null;
                
                // Convert Y position back to actual value
                // Chart Y range: 30-160 (130px range)
                const yRange = 130;
                const yFromTop = closestPoint.y - 30;
                const valuePercent = 1 - (yFromTop / yRange); // Invert because Y increases downward
                
                // Get value range from Y labels
                if (!currentChartData.yLabels || currentChartData.yLabels.length === 0) return null;
                
                const maxValue = parseFloat(currentChartData.yLabels[0].text.replace('£', '').replace('k', '')) * 1000;
                const minValue = parseFloat(currentChartData.yLabels[currentChartData.yLabels.length - 1].text.replace('£', '').replace('k', '')) * 1000;
                
                return minValue + (maxValue - minValue) * valuePercent;
            }
            
            function getDateInfo(chartX) {
                const closestPoint = getClosestDataPoint(chartX);
                return closestPoint ? closestPoint.label : '';
            }
        }

        // Initialize chart on page load with MAX view
        document.addEventListener('DOMContentLoaded', function() {
            // Force MAX view to be active on load
            currentRange = '';
            updateChart('MAX');
            
            // Prevent default touch behaviors on chart area
            document.getElementById('chartOverlay').addEventListener('touchstart', function(e) {
                e.preventDefault();
            }, { passive: false });
        });
    </script>
</body>
</html>

{% block scripts %}
<script>
// Mobile Chart Implementation
document.addEventListener('DOMContentLoaded', function() {
    // Mobile-optimized chart
    const mobileCtx = document.getElementById('mobileNetWorthChart').getContext('2d');
    
    // Simplified chart for mobile
    fetch('/api/chart-data')
        .then(response => response.json())
        .then(data => {
            document.getElementById('mobileChartLoading').style.display = 'none';
            
            new Chart(mobileCtx, {
                type: 'line',
                data: {
                    labels: data.labels.slice(-12), // Last 12 months only
                    datasets: [{
                        label: 'Net Worth',
                        data: data.values.slice(-12),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        pointBackgroundColor: '#3b82f6',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#9ca3af',
                                maxTicksLimit: 6
                            }
                        },
                        y: {
                            display: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#9ca3af',
                                callback: function(value) {
                                    return '£' + (value / 1000).toFixed(0) + 'k';
                                }
                            }
                        }
                    }
                }
            });
        })
        .catch(error => {
            console.error('Error loading mobile chart:', error);
            document.getElementById('mobileChartLoading').innerHTML = 
                '<p class="text-red-400 text-sm">Error loading chart</p>';
        });
});

// Mobile-specific interactions
function showSettings() {
    alert('Settings functionality coming soon!');
}

// Touch-friendly interactions
document.addEventListener('touchstart', function() {}, true);
</script>
{% endblock %}