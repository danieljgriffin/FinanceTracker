{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6" style="background: transparent !important;">
    <!-- Header with Alerts -->
    <div class="flex items-center justify-between mb-6">
        <h1 class="text-2xl lg:text-3xl font-bold text-white">Financial Command Center</h1>
        <div class="flex items-center space-x-4">
            <!-- Quick Actions -->
            <button onclick="openPlatformModal()" class="px-4 py-2 text-white font-medium rounded-xl border border-steel-500 transition-all duration-300" style="background-color: #BB86FC;" onmouseover="this.style.backgroundColor='#A374E6'" onmouseout="this.style.backgroundColor='#BB86FC'">
                <i class="fas fa-link mr-2"></i>Connect Accounts
            </button>
            <div id="price-status" class="text-sm text-gray-400">Loading...</div>
        </div>
    </div>

    <!-- Alerts Bar -->
    {% if dashboard_analytics.alerts %}
    <div class="mb-6">
        {% for alert in dashboard_analytics.alerts %}
        <div class="bg-{{ 'red' if alert.type == 'error' else 'yellow' }}-900/20 border border-{{ 'red' if alert.type == 'error' else 'yellow' }}-500/30 rounded-xl p-3 mb-2">
            <div class="flex items-center">
                <i class="fas fa-{{ 'exclamation-triangle' if alert.type == 'error' else 'clock' }} text-{{ 'red' if alert.type == 'error' else 'yellow' }}-400 mr-3"></i>
                <span class="text-white text-sm">{{ alert.message }}</span>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Top KPI Row -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <!-- Current Net Worth -->
        <div class="bg-slate-800 border border-steel-500 rounded-xl p-4">
            <p class="text-sm font-medium text-gray-300 mb-1">Net Worth</p>
            <p class="text-xl font-bold text-white privacy-sensitive">Â£{{ "{:,.0f}".format(current_net_worth) }}</p>
        </div>

        <!-- Month-on-Month -->
        <div class="bg-slate-800 border border-steel-500 rounded-xl p-4">
            <p class="text-sm font-medium text-gray-300 mb-1">Month-on-Month</p>
            <p class="text-lg font-bold {% if mom_change >= 0 %}text-green-400{% else %}text-red-400{% endif %}">
                {% if mom_amount_change >= 0 %}+Â£{{ "{:,.0f}".format(mom_amount_change) }}{% else %}-Â£{{ "{:,.0f}".format(-mom_amount_change) }}{% endif %}
            </p>
            <p class="text-xs text-gray-400">({{ "{:+.1f}".format(mom_change) }}%)</p>
        </div>

        <!-- Total Cash -->
        <div class="bg-slate-800 border border-steel-500 rounded-xl p-4">
            <p class="text-sm font-medium text-gray-300 mb-1">Available Cash</p>
            <p class="text-lg font-bold text-green-400 privacy-sensitive">Â£{{ "{:,.0f}".format(dashboard_analytics.total_cash.total if dashboard_analytics.total_cash else 0) }}</p>
            <p class="text-xs text-gray-400">Across {{ (dashboard_analytics.total_cash.by_platform|length) if dashboard_analytics.total_cash else 0 }} platform{{ 's' if (dashboard_analytics.total_cash.by_platform|length if dashboard_analytics.total_cash else 0) != 1 else '' }}</p>
        </div>

        <!-- Daily P/L -->
        <div class="bg-slate-800 border border-steel-500 rounded-xl p-4">
            <p class="text-sm font-medium text-gray-300 mb-1">Daily P/L</p>
            <p class="text-lg font-bold {% if dashboard_analytics.daily_pl.amount >= 0 %}text-green-400{% else %}text-red-400{% endif %}">
                {% if dashboard_analytics.daily_pl.amount >= 0 %}+Â£{{ "{:,.0f}".format(dashboard_analytics.daily_pl.amount) }}{% else %}-Â£{{ "{:,.0f}".format(-dashboard_analytics.daily_pl.amount) }}{% endif %}
            </p>
            <p class="text-xs text-gray-400">({{ "{:+.1f}".format(dashboard_analytics.daily_pl.percent) }}%)</p>
        </div>
    </div>

    <!-- Main Layout: Chart + Platform Allocations + Top Movers -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- 12-Month Net Worth Trend Chart -->
        <div class="lg:col-span-2 bg-slate-800 border border-steel-500 rounded-xl p-6">
            <h2 class="text-xl font-semibold text-white mb-4">12-Month Net Worth Trend</h2>
            <div class="h-64">
                <canvas id="netWorthChart"></canvas>
            </div>
        </div>

        <!-- Platform Allocations -->
        <div class="bg-slate-800 border border-steel-500 rounded-xl p-6">
            <h2 class="text-xl font-semibold text-white mb-4">Platform Allocations</h2>
            <div class="space-y-3">
                {% for platform, value in platform_allocations.items() %}
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-3 h-3 rounded-full mr-3" style="background-color: {{ platform_colors.get(platform, '#64748b') }};"></div>
                        <span class="text-sm text-gray-300">{{ platform }}</span>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-medium text-white privacy-sensitive">Â£{{ "{:,.0f}".format(value) }}</p>
                        <p class="text-xs text-gray-400">{{ "{:.1f}".format(platform_percentages.get(platform, 0)) }}%</p>
                        {% set monthly_change = platform_monthly_changes.get(platform, {}) %}
                        {% if monthly_change and monthly_change.amount != 0 %}
                        <p class="text-xs {% if monthly_change.amount >= 0 %}text-green-400{% else %}text-red-400{% endif %}">
                            {% if monthly_change.amount >= 0 %}+{% endif %}Â£{{ "{:,.0f}".format(monthly_change.amount) }}
                        </p>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Bottom Row: Top Movers + Goals Snapshot -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
        <!-- Top Movers -->
        <div class="bg-slate-800 border border-steel-500 rounded-xl p-6">
            <h2 class="text-xl font-semibold text-white mb-4">Top Movers</h2>
            
            <!-- Top Gainers -->
            {% if dashboard_analytics.top_movers.gainers %}
            <div class="mb-6">
                <h3 class="text-sm font-medium text-green-400 mb-3">ðŸ“ˆ Biggest Gainers</h3>
                <div class="space-y-2">
                    {% for gainer in dashboard_analytics.top_movers.gainers[:3] %}
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-white">{{ gainer.symbol }}</p>
                            <p class="text-xs text-gray-400">{{ gainer.platform }}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-green-400">+Â£{{ "{:,.0f}".format(gainer.change_amount) }}</p>
                            <p class="text-xs text-green-400">+{{ "{:.1f}".format(gainer.change_percent) }}%</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Top Losers -->
            {% if dashboard_analytics.top_movers.losers %}
            <div>
                <h3 class="text-sm font-medium text-red-400 mb-3">ðŸ“‰ Biggest Losers</h3>
                <div class="space-y-2">
                    {% for loser in dashboard_analytics.top_movers.losers[:3] %}
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-white">{{ loser.symbol }}</p>
                            <p class="text-xs text-gray-400">{{ loser.platform }}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-red-400">-Â£{{ "{:,.0f}".format(-loser.change_amount) }}</p>
                            <p class="text-xs text-red-400">{{ "{:.1f}".format(loser.change_percent) }}%</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            {% if not dashboard_analytics.top_movers.gainers and not dashboard_analytics.top_movers.losers %}
            <div class="text-center py-8">
                <i class="fas fa-chart-line text-gray-500 text-3xl mb-3"></i>
                <p class="text-gray-400">No significant movers today</p>
            </div>
            {% endif %}
        </div>

        <!-- Goals Snapshot -->
        <div class="bg-slate-800 border border-steel-500 rounded-xl p-6">
            <h2 class="text-xl font-semibold text-white mb-4">Goals Snapshot</h2>
            
            {% if next_target %}
            <div class="mb-4">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-sm font-medium text-white">{{ next_target.title }}</h3>
                    <span class="text-xs text-gray-400">Target: {{ next_target.target_date.strftime('%b %Y') }}</span>
                </div>
                
                <!-- Progress Bar -->
                <div class="w-full bg-gray-700 rounded-full h-2 mb-2">
                    <div class="h-2 rounded-full transition-all duration-300" 
                         style="width: {{ progress_info.progress_percentage }}%; background: linear-gradient(135deg, #BB86FC, #A374E6, #8B5FD9) !important;">
                    </div>
                </div>
                
                <div class="flex items-center justify-between text-sm">
                    <span class="text-gray-300">Â£{{ "{:,.0f}".format(current_net_worth) }} / Â£{{ "{:,.0f}".format(next_target.target_amount) }}</span>
                    <span class="text-{{ 'green' if progress_info.is_achieved else 'purple' }}-400">{{ "{:.1f}".format(progress_info.progress_percentage) }}%</span>
                </div>
                
                {% if not progress_info.is_achieved %}
                <div class="mt-3 text-xs text-gray-400">
                    <p>Â£{{ "{:,.0f}".format(progress_info.remaining_amount) }} remaining</p>
                    <p>{{ progress_info.days_remaining }} days left</p>
                </div>
                {% else %}
                <div class="mt-3 text-xs text-green-400">
                    <p><i class="fas fa-check-circle mr-1"></i>Goal achieved!</p>
                </div>
                {% endif %}
            </div>

            <!-- Upcoming Goals -->
            {% if upcoming_targets %}
            <div class="border-t border-steel-500 pt-4">
                <h4 class="text-sm font-medium text-gray-300 mb-2">Next Goals</h4>
                <div class="space-y-2">
                    {% for goal in upcoming_targets[:2] %}
                    <div class="flex items-center justify-between">
                        <span class="text-xs text-gray-400">{{ goal.title }}</span>
                        <span class="text-xs text-gray-400">Â£{{ "{:,.0f}".format(goal.target_amount) }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <div class="mt-4 pt-4 border-t border-steel-500">
                <a href="{{ url_for('goals') }}" class="inline-flex items-center px-4 py-2 text-white rounded-lg border border-steel-500 transition-colors text-sm" style="background-color: #BB86FC;" onmouseover="this.style.backgroundColor='#A374E6'" onmouseout="this.style.backgroundColor='#BB86FC'">
                    <i class="fas fa-bullseye mr-2"></i>Manage Goals
                </a>
            </div>
            {% else %}
            <div class="text-center py-8">
                <i class="fas fa-bullseye text-gray-500 text-3xl mb-3"></i>
                <h3 class="text-lg font-semibold text-gray-300 mb-2">No Active Goals</h3>
                <p class="text-gray-400 mb-4">Set your first financial goal</p>
                <a href="{{ url_for('goals') }}" class="inline-flex items-center px-4 py-2 text-white rounded-lg border border-steel-500 transition-colors" style="background-color: #BB86FC;" onmouseover="this.style.backgroundColor='#A374E6'" onmouseout="this.style.backgroundColor='#BB86FC'">
                    <i class="fas fa-plus mr-2"></i>Create Goal
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Chart.js Script -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 12-Month Net Worth Trend Chart
    const ctx = document.getElementById('netWorthChart').getContext('2d');
    const trendData = {{ dashboard_analytics.twelve_month_trend | tojson }};
    
    // Ensure we have data before initializing chart
    if (trendData && trendData.length > 0) {
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: trendData.map(d => d.month + ' ' + d.year),
                datasets: [{
                    label: 'Net Worth',
                    data: trendData.map(d => d.value),
                    borderColor: '#BB86FC',
                    backgroundColor: 'rgba(187, 134, 252, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: trendData.map(d => d.is_current ? '#03DAC5' : '#BB86FC'),
                    pointBorderColor: trendData.map(d => d.is_current ? '#03DAC5' : '#BB86FC'),
                    pointRadius: trendData.map(d => d.is_current ? 6 : 4),
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        ticks: {
                            color: '#9ca3af',
                            callback: function(value) {
                                return 'Â£' + (value / 1000).toFixed(0) + 'k';
                            }
                        },
                        grid: {
                            color: 'rgba(156, 163, 175, 0.1)'
                        }
                    },
                    x: {
                        ticks: {
                            color: '#9ca3af'
                        },
                        grid: {
                            color: 'rgba(156, 163, 175, 0.1)'
                        }
                    }
                },
                interaction: {
                    intersect: false,
                },
                elements: {
                    point: {
                        hoverRadius: 8
                    }
                }
            }
        });
    } else {
        // Show message if no data available
        const chartContainer = document.getElementById('netWorthChart').parentElement;
        chartContainer.innerHTML = '<div class="flex items-center justify-center h-64 text-gray-400"><p>No historical data available</p></div>';
    }
});
</script>

{% include 'platform_connection_modal.html' %}
{% endblock %}