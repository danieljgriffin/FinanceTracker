{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="container mx-auto px-4 sm:px-6 lg:px-8 py-6 sm:py-8" style="background: transparent !important;">
    <!-- Desktop Only: Price Status -->
    <div class="hidden md:flex items-center justify-between mb-4 sm:mb-6">
        <h1 class="text-xl sm:text-2xl lg:text-3xl font-bold text-white">Financial Dashboard</h1>
        <div class="text-right">
            <div id="price-status" class="text-xs sm:text-sm text-gray-400">Loading price status...</div>
        </div>
    </div>

    <!-- Mobile Only: Header and Status -->
    <div class="md:hidden mb-4 sm:mb-6">
        <div class="flex flex-col space-y-3">
            <h1 class="text-xl sm:text-2xl font-bold text-white text-center">Financial Dashboard</h1>
            <div class="text-center">
                <div id="price-status-mobile" class="text-xs text-gray-400">Loading...</div>
            </div>
        </div>
    </div>

    <!-- Top Stats Row -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-6 sm:mb-8">
        <!-- Current Net Worth -->
        <div class="card p-3 sm:p-4 lg:p-6">
            <div class="flex items-center justify-between">
                <div class="flex-1 min-w-0">
                    <p class="text-xs sm:text-sm font-medium text-gray-300 mb-1 sm:mb-2">Current Net Worth</p>
                    <p class="text-lg sm:text-xl lg:text-2xl font-bold text-white truncate financial-figure">£{{ "{:,.2f}".format(current_net_worth) }}</p>
                </div>
            </div>
        </div>

        <!-- Month-on-Month Change -->
        <div class="card p-3 sm:p-4 lg:p-6">
            <div class="flex items-center justify-between">
                <div class="flex-1 min-w-0">
                    <p class="text-xs sm:text-sm font-medium text-gray-300 mb-1 sm:mb-2">Month-on-Month</p>
                    <p class="text-lg sm:text-xl lg:text-2xl font-bold {% if mom_change >= 0 %}text-green-600{% else %}text-red-600{% endif %} mt-1">
                        {% if mom_amount_change >= 0 %}+£{{ "{:,.0f}".format(mom_amount_change) }}{% else %}-£{{ "{:,.0f}".format(-mom_amount_change) }}{% endif %} ({{ "{:+.1f}".format(mom_change) }}%)
                    </p>
                </div>
            </div>
        </div>

        <!-- Yearly Net Worth Increase -->
        <div class="card p-3 sm:p-4 lg:p-6">
            <div class="flex items-center justify-between">
                <div class="flex-1 min-w-0">
                    <p class="text-xs sm:text-sm font-medium text-gray-300 mb-1 sm:mb-2">Yearly Net Worth Increase</p>
                    <p class="text-lg sm:text-xl lg:text-2xl font-bold {% if yearly_increase > 0 %}text-green-600{% elif yearly_increase < 0 %}text-red-600{% else %}text-gray-600{% endif %} mt-1">
                        {% if yearly_amount_change >= 0 %}+£{{ "{:,.0f}".format(yearly_amount_change) }}{% elif yearly_increase < 0 %}-£{{ "{:,.0f}".format(-yearly_amount_change) }}{% else %}£{{ "{:,.0f}".format(yearly_amount_change) }}{% endif %} ({{ "{:+.1f}".format(yearly_increase) }}%)
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Layout: Sidebar + Right Column -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6" style="background: transparent !important;">
        <!-- Net Worth Breakdown (Left Third) -->
        <div class="card lg:col-span-1" style="background: rgba(255, 255, 255, 0.05) !important;">
            <div class="px-4 sm:px-6 py-4 sm:py-6 border-b border-gray-600/30">
                <h2 class="text-lg sm:text-xl font-semibold text-white">Net Worth Breakdown</h2>
            </div>
            <div class="p-3 sm:p-4 lg:p-6">
                {% if platform_allocations %}
                    <div class="space-y-3 sm:space-y-4">
                        {% for platform, amount in platform_allocations.items() %}
                            <div class="flex items-center justify-between py-2 sm:py-3">
                                <div class="flex items-center">
                                    <div class="w-3 h-3 sm:w-4 sm:h-4 rounded-full mr-3 sm:mr-4 flex-shrink-0" style="background-color: {{ platform_colors.get(platform, '#6b7280') }}"></div>
                                    <div>
                                        <h3 class="font-medium text-white text-sm sm:text-base">{{ platform }}</h3>
                                        <p class="text-xs sm:text-sm text-gray-400">{{ "{:.1f}".format(platform_percentages.get(platform, 0)) }}% of total</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="font-bold text-white text-base sm:text-lg financial-figure">£{{ "{:,.0f}".format(amount) }}</div>
                                    {% set change_data = platform_monthly_changes.get(platform, {}) %}
                                    {% if change_data.get('previous', 0) > 0 %}
                                        {% set change_amount = change_data.get('amount', 0) %}
                                        {% set change_percent = change_data.get('percent', 0) %}
                                        <div class="mt-0.5">
                                            {% if change_amount > 0 %}
                                                <span class="inline-flex items-center text-green-500 text-xs sm:text-sm font-medium">
                                                    <i class="fas fa-arrow-up mr-1"></i>
                                                    +£{{ "{:,.0f}".format(change_amount) }} (+{{ "{:.1f}".format(change_percent) }}%)
                                                </span>
                                            {% elif change_amount < 0 %}
                                                <span class="inline-flex items-center text-red-500 text-xs sm:text-sm font-medium">
                                                    <i class="fas fa-arrow-down mr-1"></i>
                                                    -£{{ "{:,.0f}".format(-change_amount) }} ({{ "{:.1f}".format(change_percent) }}%)
                                                </span>
                                            {% else %}
                                                <span class="inline-flex items-center text-gray-400 text-xs sm:text-sm">
                                                    <i class="fas fa-minus mr-1"></i>
                                                    No change
                                                </span>
                                            {% endif %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-6 sm:py-8">
                        <i class="fas fa-chart-pie text-gray-400 text-2xl sm:text-3xl lg:text-4xl mb-3 sm:mb-4"></i>
                        <p class="text-gray-400 text-sm sm:text-base">No allocation data available</p>
                        <p class="text-xs sm:text-sm text-gray-500">Add investments to see net worth allocation</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Right Column: Financial Target Progress + Charts -->
        <div class="lg:col-span-2 space-y-6" style="background: transparent !important;">
            <!-- Financial Target Progress -->
            <div class="card" style="background: rgba(255, 255, 255, 0.05) !important;">
                <div class="px-4 sm:px-6 lg:px-8 py-4 sm:py-6 border-b border-gray-600/30">
                    <h2 class="text-lg sm:text-xl font-semibold text-white">
                        Financial Target Progress{% if next_target %} - {{ next_target.target_date.strftime('%b %Y') }} Target{% endif %}
                    </h2>
                </div>
                <div class="p-3 sm:p-4">
                    {% if next_target %}
                    <div class="space-y-4">
                        <!-- Goal Name -->
                        <div class="text-left">
                            <h3 class="text-lg font-medium text-gray-300">{{ next_target.name }}</h3>
                        </div>
                        
                        {% if progress_info %}
                        <!-- Enhanced Progress Bar Section -->
                        <div class="space-y-3">
                            <div class="flex justify-between items-center px-1">
                                <span class="text-gray-300 font-medium text-base">Progress</span>
                                <span class="text-lg font-semibold text-white bg-gray-700/50 px-3 py-1 rounded-full">{{ "{:.1f}".format(progress_info.progress_percentage) }}%</span>
                            </div>
                            
                            <div class="relative">
                                <!-- Progress Bar Container -->
                                <div class="w-full bg-gray-700/50 rounded-xl h-12 relative overflow-hidden">
                                    <!-- Progress Fill with enhanced styling -->
                                    <div class="h-full rounded-xl flex items-center justify-center transition-all duration-1000 shadow-lg" 
                                         style="width: {{ progress_info.progress_percentage }}%; background: linear-gradient(135deg, #60a5fa, #3b82f6, #2563eb) !important;">
                                        <!-- Current Value Inside Bar -->
                                        {% if progress_info.progress_percentage > 20 %}
                                        <span class="text-white font-semibold text-sm drop-shadow-lg">£{{ "{:,.0f}".format(current_net_worth) }}</span>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Current Value Outside Bar (if bar too small) -->
                                    {% if progress_info.progress_percentage <= 20 %}
                                    <div class="absolute left-4 top-1/2 transform -translate-y-1/2">
                                        <span class="text-white font-semibold text-sm bg-gray-800/80 px-2 py-1 rounded">£{{ "{:,.0f}".format(current_net_worth) }}</span>
                                    </div>
                                    {% endif %}
                                    
                                    <!-- Target Amount at End -->
                                    <div class="absolute right-4 top-1/2 transform -translate-y-1/2">
                                        <span class="text-gray-200 font-semibold text-sm bg-gray-800/80 px-2 py-1 rounded">£{{ "{:,.0f}".format(next_target.target_amount) }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Compact Progress Indicators Below Progress Bar -->
                        <div class="grid grid-cols-2 gap-6">
                            <!-- Days Remaining (Purple) - Compact -->
                            <div class="bg-gradient-to-br from-purple-500/15 to-purple-600/25 rounded-lg p-2 border border-purple-400/20 backdrop-blur-sm">
                                <div class="text-center">
                                    <div class="text-purple-300 text-xs font-medium mb-1 uppercase tracking-wide">Days Remaining</div>
                                    <div class="text-xl font-semibold text-purple-200">
                                        {{ progress_info.days_remaining if progress_info.days_remaining > 0 else 0 }}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Amount Remaining (Blue) - Compact -->
                            <div class="bg-gradient-to-br from-blue-500/15 to-blue-600/25 rounded-lg p-2 border border-blue-400/20 backdrop-blur-sm">
                                <div class="text-center">
                                    <div class="text-blue-300 text-xs font-medium mb-1 uppercase tracking-wide">Amount Remaining</div>
                                    <div class="text-xl font-semibold text-blue-200">
                                        £{{ "{:,.0f}".format(progress_info.remaining_amount) }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Enhanced Action Buttons -->
                        <div class="flex gap-6 pt-1">
                            <!-- View Goals Button -->
                            <a href="{{ url_for('goals') }}" 
                               class="flex-1 flex items-center justify-center py-2 px-4 bg-gradient-to-r from-gray-700/70 to-gray-600/70 hover:from-gray-600/80 hover:to-gray-500/80 rounded-lg transition-all duration-300 border border-gray-500/30 backdrop-blur-sm shadow-lg group">
                                <i class="fas fa-bullseye text-gray-200 mr-2 group-hover:text-white transition-colors"></i>
                                <span class="text-gray-200 font-medium group-hover:text-white transition-colors">View Goals</span>
                            </a>
                            
                            <!-- Complete Goal Button -->
                            <button onclick="markGoalComplete('{{ next_target.id }}')" 
                                    class="px-3 py-2 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-400 hover:to-green-500 rounded-lg transition-all duration-300 border border-green-400/30 shadow-lg transform hover:scale-105 group">
                                <i class="fas fa-check text-white text-lg group-hover:scale-110 transition-transform"></i>
                            </button>
                        </div>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="text-center py-8 lg:py-12">
                        <i class="fas fa-bullseye text-gray-500 text-4xl lg:text-5xl mb-4"></i>
                        <h3 class="text-lg font-semibold text-gray-300 mb-2">No Active Financial Targets</h3>
                        <p class="text-gray-400 mb-4">Set your first financial goal to track your progress</p>
                        <a href="{{ url_for('goals') }}" class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                            <i class="fas fa-plus mr-2"></i>Create Your First Goal
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Charts Section -->
            <div class="card" style="background: rgba(255, 255, 255, 0.05) !important;">
                <div class="px-4 sm:px-6 py-4 sm:py-6 border-b border-gray-600/30">
                    <h2 class="text-lg sm:text-xl font-semibold text-white">Net Worth Charts</h2>
                </div>
                <div class="p-3 sm:p-4 lg:p-6">
                    <div class="mb-4 space-y-3">
                        <!-- Chart Type Switcher -->
                        <div class="flex justify-center">
                            <div class="flex bg-gray-700/50 rounded-lg p-1">
                                <button id="lineChartBtnCharts" onclick="switchChartTypeCharts('line')" 
                                        class="px-3 py-1.5 text-xs font-medium rounded-md transition-colors text-gray-300 hover:text-white">
                                    <i class="fas fa-chart-line mr-1"></i>Line Chart
                                </button>
                                <button id="barChartBtnCharts" onclick="switchChartTypeCharts('bar')" 
                                        class="px-3 py-1.5 text-xs font-medium rounded-md transition-colors bg-blue-600 text-white">
                                    <i class="fas fa-chart-bar mr-1"></i>Stacked Bar
                                </button>
                            </div>
                        </div>
                        
                        <!-- Year Filters -->
                        <div class="flex flex-wrap gap-2 justify-center">
                            <button onclick="filterYearCharts('2025')" class="year-filter-charts px-3 py-1 text-xs rounded-lg bg-blue-600 text-white" data-year="2025">2025</button>
                            <button onclick="filterYearCharts('2024')" class="year-filter-charts px-3 py-1 text-xs rounded-lg bg-gray-600 text-gray-300" data-year="2024">2024</button>
                            <button onclick="filterYearCharts('2023')" class="year-filter-charts px-3 py-1 text-xs rounded-lg bg-gray-600 text-gray-300" data-year="2023">2023</button>
                            <button onclick="filterYearCharts('2024-2025')" class="year-filter-charts px-3 py-1 text-xs rounded-lg bg-gray-600 text-gray-300" data-year="2024-2025">2024-25</button>
                            <button onclick="filterYearCharts('all')" class="year-filter-charts px-3 py-1 text-xs rounded-lg bg-gray-600 text-gray-300" data-year="all">All Years</button>
                        </div>
                    </div>
                    <div class="relative h-80 bg-gray-800/50 rounded-xl p-4">
                        <canvas id="networthChartSeparate" width="400" height="300"></canvas>
                    </div>
                    <div id="chartLoadingSeparate" class="text-center py-8">
                        <i class="fas fa-spinner fa-spin text-gray-400 text-2xl mb-2"></i>
                        <p class="text-gray-400 text-sm">Loading chart data...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Mobile-specific JavaScript
    function updatePriceStatusMobile() {
        fetch('/api/price-status')
            .then(response => response.json())
            .then(data => {
                const statusElement = document.getElementById('price-status-mobile');
                if (statusElement) {
                    if (data.last_updated && data.current_date) {
                        const statusHtml = `
                            <div>Last updated: ${data.current_date}</div>
                            <div>Prices refreshed: ${data.last_updated} (next in ${data.minutes_until_next}m)</div>
                        `;
                        statusElement.innerHTML = statusHtml;
                    } else {
                        statusElement.innerHTML = `
                            <div>Last updated: ${data.current_date || 'Unknown'}</div>
                            <div>Prices refreshed: Never</div>
                        `;
                    }
                }
            })
            .catch(error => {
                console.error('Error fetching mobile price status:', error);
            });
    }

    // Update mobile price status every 30 seconds
    setInterval(updatePriceStatusMobile, 30000);
    
    // Update on page load
    updatePriceStatusMobile();
    
    // Auto-refresh price status every 30 seconds
    function updatePriceStatus() {
        fetch('/api/price-status')
            .then(response => response.json())
            .then(data => {
                const statusElement = document.getElementById('price-status');
                if (statusElement) {
                    if (data.last_updated && data.current_date) {
                        const statusHtml = `
                            <div>Last updated: ${data.current_date}</div>
                            <div>Prices refreshed: ${data.last_updated} (next in ${data.minutes_until_next}m)</div>
                        `;
                        statusElement.innerHTML = statusHtml;
                    } else {
                        statusElement.innerHTML = `
                            <div>Last updated: ${data.current_date || 'Unknown'}</div>
                            <div>Prices refreshed: Never</div>
                        `;
                    }
                }
            })
            .catch(error => {
                console.error('Error fetching price status:', error);
            });
    }

    // Update price status every 30 seconds
    setInterval(updatePriceStatus, 30000);
    
    // Update on page load
    updatePriceStatus();
    
    function refreshPrices() {
        const button = document.querySelector('button[onclick="refreshPrices()"]');
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1 sm:mr-2"></i>Refreshing...';
        button.disabled = true;
        
        fetch('/api/refresh-prices', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Prices refreshed successfully!', 'success');
                    // Reload the page to show updated data
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    showNotification('Failed to refresh prices: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Failed to refresh prices', 'error');
            })
            .finally(() => {
                button.innerHTML = originalText;
                button.disabled = false;
            });
    }
    
    function showNotification(message, type) {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 p-4 rounded-lg text-white z-50 ${
            type === 'success' ? 'bg-green-600' : 'bg-red-600'
        }`;
        notification.textContent = message;
        
        // Add to page
        document.body.appendChild(notification);
        
        // Remove after 3 seconds
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }
    
    // Chart variables
    let currentChartTypeCharts = 'bar';
    let currentYearFilterSeparate = '2025';
    let networthChartSeparate;
    
    // Chart type switching for separate charts section
    function switchChartTypeCharts(type) {
        currentChartTypeCharts = type;
        
        // Update button states
        document.getElementById('lineChartBtnCharts').className = 'px-3 py-1.5 text-xs font-medium rounded-md transition-colors ' + 
            (type === 'line' ? 'bg-blue-600 text-white' : 'text-gray-300 hover:text-white');
        document.getElementById('barChartBtnCharts').className = 'px-3 py-1.5 text-xs font-medium rounded-md transition-colors ' + 
            (type === 'bar' ? 'bg-blue-600 text-white' : 'text-gray-300 hover:text-white');
        
        // Reload chart with new type
        loadChartDataSeparate(currentYearFilterSeparate);
    }
    
    // Year filtering for separate charts
    function filterYearCharts(year) {
        currentYearFilterSeparate = year;
        
        // Update button states
        document.querySelectorAll('.year-filter-charts').forEach(btn => {
            if (btn.dataset.year === year) {
                btn.className = 'year-filter-charts px-3 py-1 text-xs rounded-lg bg-blue-600 text-white';
            } else {
                btn.className = 'year-filter-charts px-3 py-1 text-xs rounded-lg bg-gray-600 text-gray-300';
            }
        });
        
        // Reload chart data
        loadChartDataSeparate(year);
    }
    
    // Load chart data for separate charts section
    function loadChartDataSeparate(year) {
        const chartLoadingElement = document.getElementById('chartLoadingSeparate');
        if (chartLoadingElement) {
            chartLoadingElement.style.display = 'block';
        }
        
        fetch(`/api/networth-chart-data?year=${year}&type=${currentChartTypeCharts}`)
            .then(response => response.json())
            .then(data => {
                if (chartLoadingElement) {
                    chartLoadingElement.style.display = 'none';
                }
                
                const ctx = document.getElementById('networthChartSeparate');
                if (!ctx) return;
                
                // Destroy existing chart
                if (networthChartSeparate) {
                    networthChartSeparate.destroy();
                }
                
                const chartData = {
                    labels: data.labels || [],
                    datasets: data.datasets || []
                };
                
                const config = {
                    type: currentChartTypeCharts,
                    data: chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { color: '#e5e7eb', boxWidth: 12 }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                backgroundColor: 'rgba(31, 41, 55, 0.95)',
                                titleColor: '#f3f4f6',
                                bodyColor: '#e5e7eb',
                                borderColor: '#6b7280',
                                borderWidth: 1,
                                callbacks: {
                                    footer: function(tooltipItems) {
                                        // Calculate total for the month (for stacked bars, sum all values)
                                        let total = 0;
                                        if (currentChartTypeCharts === 'bar') {
                                            // For stacked bars, show the total across all platforms for this month
                                            tooltipItems.forEach(function(tooltipItem) {
                                                total += tooltipItem.parsed.y;
                                            });
                                        } else {
                                            // For line charts, sum all datasets for this point
                                            const dataIndex = tooltipItems[0].dataIndex;
                                            tooltipItems[0].chart.data.datasets.forEach(function(dataset) {
                                                if (dataset.data[dataIndex]) {
                                                    total += dataset.data[dataIndex];
                                                }
                                            });
                                        }
                                        return 'Total: £' + total.toLocaleString();
                                    },
                                    label: function(context) {
                                        return context.dataset.label + ': £' + context.parsed.y.toLocaleString();
                                    }
                                }
                            }
                        },
                        scales: {
                            x: { 
                                ticks: { color: '#9ca3af' },
                                grid: { color: '#374151' }
                            },
                            y: { 
                                ticks: { 
                                    color: '#9ca3af',
                                    callback: function(value) { return '£' + value.toLocaleString(); }
                                },
                                grid: { color: '#374151' }
                            }
                        }
                    }
                };
                
                if (currentChartTypeCharts === 'bar') {
                    config.options.scales.x.stacked = true;
                    config.options.scales.y.stacked = true;
                }
                
                networthChartSeparate = new Chart(ctx, config);
            })
            .catch(error => {
                console.error('Error loading chart data:', error);
                if (chartLoadingElement) {
                    chartLoadingElement.innerHTML = '<p class="text-red-400 text-sm">Error loading chart data</p>';
                }
            });
    }
    
    // Mark goal as complete
    function markGoalComplete(goalId) {
        if (confirm('Mark this goal as completed? This will move to the next active goal.')) {
            fetch(`/api/complete-goal/${goalId}`, { 
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Goal marked as completed!', 'success');
                    // Reload to show next goal
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    showNotification('Failed to complete goal: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Failed to complete goal', 'error');
            });
        }
    }
    
    // Initialize charts when page loads
    document.addEventListener('DOMContentLoaded', function() {
        if (document.getElementById('networthChartSeparate')) {
            loadChartDataSeparate(currentYearFilterSeparate);
        }
    });
</script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}