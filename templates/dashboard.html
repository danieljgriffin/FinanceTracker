{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="container mx-auto px-2 sm:px-4 lg:px-6 py-2 sm:py-4" style="background: transparent !important;">
    <!-- Desktop Only: Price Status -->
    <div class="hidden md:flex items-center justify-between mb-3 sm:mb-4">
        <h1 class="text-xl sm:text-2xl lg:text-3xl font-bold text-white">Financial Dashboard</h1>
        <div class="text-right">
            <div id="price-status" class="text-xs sm:text-sm text-gray-400">Loading price status...</div>
        </div>
    </div>

    <!-- Mobile Only: Header and Status -->
    <div class="md:hidden mb-3 sm:mb-4">
        <div class="flex flex-col space-y-3">
            <h1 class="text-xl sm:text-2xl font-bold text-white text-center">Financial Dashboard</h1>
            <div class="text-center">
                <div id="price-status-mobile" class="text-xs text-gray-400">Loading...</div>
            </div>
        </div>
    </div>

    <!-- Top Stats Row -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-4 sm:mb-6">
        <!-- Current Net Worth -->
        <div class="card p-3 sm:p-4 lg:p-6">
            <div class="flex items-center justify-between">
                <div class="flex-1 min-w-0">
                    <p class="text-xs sm:text-sm font-medium text-gray-300 mb-1 sm:mb-2">Current Net Worth</p>
                    <p class="text-lg sm:text-xl lg:text-2xl font-bold text-white truncate privacy-sensitive">£{{ "{:,.2f}".format(current_net_worth) }}</p>
                </div>
            </div>
        </div>

        <!-- Month-on-Month Change -->
        <div class="card p-3 sm:p-4 lg:p-6">
            <div class="flex items-center justify-between">
                <div class="flex-1 min-w-0">
                    <p class="text-xs sm:text-sm font-medium text-gray-300 mb-1 sm:mb-2">Month-on-Month</p>
                    <p class="text-lg sm:text-xl lg:text-2xl font-bold {% if mom_change >= 0 %}text-green-600{% else %}text-red-600{% endif %} mt-1">
                        {% if mom_amount_change >= 0 %}+£{{ "{:,.0f}".format(mom_amount_change) }}{% else %}-£{{ "{:,.0f}".format(-mom_amount_change) }}{% endif %} ({{ "{:+.1f}".format(mom_change) }}%)
                    </p>
                </div>
            </div>
        </div>

        <!-- Yearly Net Worth Increase -->
        <div class="card p-3 sm:p-4 lg:p-6">
            <div class="flex items-center justify-between">
                <div class="flex-1 min-w-0">
                    <p class="text-xs sm:text-sm font-medium text-gray-300 mb-1 sm:mb-2">Yearly Net Worth Increase</p>
                    <p class="text-lg sm:text-xl lg:text-2xl font-bold {% if yearly_increase > 0 %}text-green-600{% elif yearly_increase < 0 %}text-red-600{% else %}text-gray-600{% endif %} mt-1">
                        {% if yearly_amount_change >= 0 %}+£{{ "{:,.0f}".format(yearly_amount_change) }}{% elif yearly_increase < 0 %}-£{{ "{:,.0f}".format(-yearly_amount_change) }}{% else %}£{{ "{:,.0f}".format(yearly_amount_change) }}{% endif %} ({{ "{:+.1f}".format(yearly_increase) }}%)
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Layout: Sidebar + Right Column -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6" style="background: transparent !important;">
        <!-- Net Worth Breakdown (Left Third) -->
        <div class="card lg:col-span-1" style="background: rgba(255, 255, 255, 0.05) !important;">
            <div class="px-4 sm:px-6 py-4 sm:py-6 border-b border-gray-600/30">
                <h2 class="text-lg sm:text-xl font-semibold text-white">Net Worth Breakdown</h2>
            </div>
            <div class="p-3 sm:p-4 lg:p-6">
                {% if platform_allocations %}
                    <div class="space-y-2">
                        {% for platform, amount in platform_allocations.items() %}
                            <div class="py-1.5">
                                <!-- Main row with platform name and amount -->
                                <div class="flex items-baseline justify-between">
                                    <div class="flex items-baseline">
                                        <div class="w-2.5 h-2.5 rounded-full mr-2 flex-shrink-0 mt-1" style="background-color: {{ platform_colors.get(platform, '#6b7280') }}"></div>
                                        <h3 class="font-medium text-white text-base">{{ platform }}</h3>
                                    </div>
                                    <div class="font-bold text-white text-sm privacy-sensitive">£{{ "{:,.0f}".format(amount) }}</div>
                                </div>
                                
                                <!-- Secondary row with percentage and change -->
                                <div class="flex justify-between mt-0.5">
                                    <div class="ml-5">
                                        <p class="text-xs text-gray-400">{{ "{:.1f}".format(platform_percentages.get(platform, 0)) }}% of total</p>
                                    </div>
                                    <div class="text-right">
                                        {% set change_data = platform_monthly_changes.get(platform, {}) %}
                                        {% if change_data.get('previous', 0) > 0 %}
                                            {% set change_amount = change_data.get('amount', 0) %}
                                            {% set change_percent = change_data.get('percent', 0) %}
                                            {% if change_amount > 0 %}
                                                <span class="inline-flex items-center text-green-500 text-xs font-medium">
                                                    <i class="fas fa-arrow-up mr-1"></i>
                                                    +£{{ "{:,.0f}".format(change_amount) }} (+{{ "{:.1f}".format(change_percent) }}%)
                                                </span>
                                            {% elif change_amount < 0 %}
                                                <span class="inline-flex items-center text-red-500 text-xs font-medium">
                                                    <i class="fas fa-arrow-down mr-1"></i>
                                                    -£{{ "{:,.0f}".format(-change_amount) }} ({{ "{:.1f}".format(change_percent) }}%)
                                                </span>
                                            {% else %}
                                                <span class="inline-flex items-center text-gray-400 text-xs">
                                                    <i class="fas fa-minus mr-1"></i>
                                                    No change
                                                </span>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-6 sm:py-8">
                        <i class="fas fa-chart-pie text-gray-400 text-2xl sm:text-3xl lg:text-4xl mb-3 sm:mb-4"></i>
                        <p class="text-gray-400 text-sm sm:text-base">No allocation data available</p>
                        <p class="text-xs sm:text-sm text-gray-500">Add investments to see net worth allocation</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Right Column: Financial Target Progress + £1M Prediction -->
        <div class="lg:col-span-2" style="background: transparent !important;">
            <!-- Split Section: Financial Target Progress + £1M Prediction -->
            <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
                <!-- Left Half: Financial Target Progress -->
                <div class="card" style="background: rgba(255, 255, 255, 0.05) !important;">
                <div class="px-4 sm:px-6 lg:px-8 py-4 sm:py-6 border-b border-gray-600/30">
                    <h2 class="text-lg sm:text-xl font-semibold text-white">
                        Financial Target Progress{% if next_target %} - {{ next_target.target_date.strftime('%b %Y') }} Target{% endif %}
                    </h2>
                </div>
                <div class="p-3 sm:p-4">
                    {% if next_target %}
                    <div class="space-y-4">
                        <!-- Goal Name -->
                        <div class="text-left">
                            <h3 class="text-lg font-medium text-gray-300">{{ next_target.name }}</h3>
                        </div>
                        
                        {% if progress_info %}
                        <!-- Enhanced Progress Bar Section -->
                        <div class="space-y-3">
                            <div class="flex justify-between items-center px-1">
                                <span class="text-gray-300 font-medium text-base">Progress</span>
                                <span class="text-lg font-semibold text-white bg-gray-700/50 px-3 py-1 rounded-full">{{ "{:.1f}".format(progress_info.progress_percentage) }}%</span>
                            </div>
                            
                            <div class="relative">
                                <!-- Progress Bar Container -->
                                <div class="w-full bg-gray-700/50 rounded-xl h-12 relative overflow-hidden">
                                    <!-- Progress Fill with enhanced styling -->
                                    <div class="h-full rounded-xl flex items-center justify-center transition-all duration-1000 shadow-lg" 
                                         style="width: {{ progress_info.progress_percentage }}%; background: linear-gradient(135deg, #60a5fa, #3b82f6, #2563eb) !important;">
                                        <!-- Current Value Inside Bar -->
                                        {% if progress_info.progress_percentage > 20 %}
                                        <span class="text-white font-semibold text-sm drop-shadow-lg privacy-sensitive">£{{ "{:,.0f}".format(current_net_worth) }}</span>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Current Value Outside Bar (if bar too small) -->
                                    {% if progress_info.progress_percentage <= 20 %}
                                    <div class="absolute left-4 top-1/2 transform -translate-y-1/2">
                                        <span class="text-white font-semibold text-sm bg-gray-800/80 px-2 py-1 rounded privacy-sensitive">£{{ "{:,.0f}".format(current_net_worth) }}</span>
                                    </div>
                                    {% endif %}
                                    
                                    <!-- Target Amount at End -->
                                    <div class="absolute right-4 top-1/2 transform -translate-y-1/2">
                                        <span class="text-gray-200 font-semibold text-sm bg-gray-800/80 px-2 py-1 rounded privacy-sensitive">£{{ "{:,.0f}".format(next_target.target_amount) }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Compact Progress Indicators Below Progress Bar -->
                        <div class="grid grid-cols-2 gap-6">
                            <!-- Days Remaining (Purple) - Compact -->
                            <div class="bg-gradient-to-br from-purple-500/15 to-purple-600/25 rounded-lg p-2 border border-purple-400/20 backdrop-blur-sm">
                                <div class="text-center">
                                    <div class="text-purple-300 text-xs font-medium mb-1 uppercase tracking-wide">Days Remaining</div>
                                    <div class="text-xl font-semibold text-purple-200 privacy-sensitive">
                                        {{ progress_info.days_remaining if progress_info.days_remaining > 0 else 0 }}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Amount Remaining (Blue) - Compact -->
                            <div class="bg-gradient-to-br from-blue-500/15 to-blue-600/25 rounded-lg p-2 border border-blue-400/20 backdrop-blur-sm">
                                <div class="text-center">
                                    <div class="text-blue-300 text-xs font-medium mb-1 uppercase tracking-wide">Amount Remaining</div>
                                    <div class="text-xl font-semibold text-blue-200 privacy-sensitive">
                                        £{{ "{:,.0f}".format(progress_info.remaining_amount) }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Enhanced Action Buttons -->
                        <div class="flex gap-6 pt-1">
                            <!-- View Goals Button -->
                            <a href="{{ url_for('goals') }}" 
                               class="flex-1 flex items-center justify-center py-2 px-4 bg-gradient-to-r from-gray-700/70 to-gray-600/70 hover:from-gray-600/80 hover:to-gray-500/80 rounded-lg transition-all duration-300 border border-gray-500/30 backdrop-blur-sm shadow-lg group">
                                <i class="fas fa-bullseye text-gray-200 mr-2 group-hover:text-white transition-colors"></i>
                                <span class="text-gray-200 font-medium group-hover:text-white transition-colors">View Goals</span>
                            </a>
                            
                            <!-- Complete Goal Button -->
                            <button onclick="markGoalComplete('{{ next_target.id }}')" 
                                    class="px-3 py-2 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-400 hover:to-green-500 rounded-lg transition-all duration-300 border border-green-400/30 shadow-lg transform hover:scale-105 group">
                                <i class="fas fa-check text-white text-lg group-hover:scale-110 transition-transform"></i>
                            </button>
                        </div>
                        
                        <!-- Upcoming Targets Section -->
                        {% if upcoming_targets %}
                        <div class="mt-6 pt-4 border-t border-gray-600/30 privacy-sensitive">
                            <h4 class="text-sm font-semibold text-gray-300 mb-3">
                                <i class="fas fa-clock mr-2 text-blue-400"></i>Upcoming Targets
                            </h4>
                            <div class="space-y-2">
                                {% for target in upcoming_targets %}
                                <div class="flex items-center justify-between p-2 bg-gray-700/30 rounded-lg hover:bg-gray-700/50 transition-colors">
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center space-x-2">
                                            <div class="w-2 h-2 bg-blue-400 rounded-full flex-shrink-0"></div>
                                            <p class="text-sm font-medium text-white truncate">{{ target.title }}</p>
                                        </div>
                                        <p class="text-xs text-gray-400 mt-1">
                                            {{ target.target_date.strftime('%b %Y') }} • £{{ "{:,.0f}".format(target.target_amount) }}
                                        </p>
                                    </div>
                                    <div class="text-right flex-shrink-0">
                                        {% set days_from_now = (target.target_date - today.date()).days %}
                                        {% set months_away = (days_from_now / 30) | round | int %}
                                        <p class="text-xs text-gray-500">
                                            {% if months_away <= 1 %}
                                                Next up
                                            {% elif months_away < 12 %}
                                                {{ months_away }} months
                                            {% else %}
                                                {{ (months_away / 12) | round | int }} years
                                            {% endif %}
                                        </p>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="text-center py-8 lg:py-12">
                        <i class="fas fa-bullseye text-gray-500 text-4xl lg:text-5xl mb-4"></i>
                        <h3 class="text-lg font-semibold text-gray-300 mb-2">No Active Financial Targets</h3>
                        <p class="text-gray-400 mb-4">Set your first financial goal to track your progress</p>
                        <a href="{{ url_for('goals') }}" class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                            <i class="fas fa-plus mr-2"></i>Create Your First Goal
                        </a>
                    </div>
                    {% endif %}
                </div>
                </div>

                <!-- Right Half: £1M Prediction Chart -->
                <div class="card" style="background: rgba(255, 255, 255, 0.05) !important;">
                    <div class="px-4 sm:px-6 lg:px-8 py-4 sm:py-6 border-b border-gray-600/30">
                        <div class="flex items-center justify-between">
                            <div>
                                <h2 class="text-lg sm:text-xl font-semibold text-white">£1M Journey Prediction</h2>
                                <p class="text-sm text-gray-400 mt-1">Based on <span id="display-annual-return">10</span>% annual return + £<span id="display-monthly-investment">1,825</span> monthly investment</p>
                            </div>
                            <button onclick="openPredictionSettings()" 
                                    class="p-2 text-gray-400 hover:text-white hover:bg-gray-700/50 rounded-lg transition-all duration-200 group"
                                    title="Edit prediction settings">
                                <i class="fas fa-cog text-sm group-hover:rotate-90 transition-transform duration-300"></i>
                            </button>
                        </div>
                    </div>
                    <div class="p-3 sm:p-4">
                        <div class="relative h-80 bg-gray-800/50 rounded-xl p-4 privacy-sensitive">
                            <canvas id="millionPredictionChart" width="400" height="300"></canvas>
                        </div>
                        <div id="predictionChartLoading" class="text-center py-8 hidden">
                            <i class="fas fa-spinner fa-spin text-gray-400 text-2xl mb-2"></i>
                            <p class="text-gray-400 text-sm">Loading prediction data...</p>
                        </div>
                        
                        <!-- Key Milestones -->
                        <div class="mt-4 space-y-2 privacy-sensitive">
                            <h3 class="text-sm font-semibold text-gray-300 mb-3">Key Milestones</h3>
                            <div class="grid grid-cols-2 gap-3 text-xs">
                                <div id="milestone-100k" class="flex justify-between p-2 bg-gray-700/30 rounded">
                                    <span class="text-gray-400">£100k:</span>
                                    <span class="text-white" id="date-100k">Calculating...</span>
                                </div>
                                <div id="milestone-250k" class="flex justify-between p-2 bg-gray-700/30 rounded">
                                    <span class="text-gray-400">£250k:</span>
                                    <span class="text-white" id="date-250k">Calculating...</span>
                                </div>
                                <div id="milestone-500k" class="flex justify-between p-2 bg-gray-700/30 rounded">
                                    <span class="text-gray-400">£500k:</span>
                                    <span class="text-white" id="date-500k">Calculating...</span>
                                </div>
                                <div id="milestone-1m" class="flex justify-between p-2 bg-gray-700/30 rounded">
                                    <span class="text-gray-400">£1M:</span>
                                    <span class="text-white" id="date-1m">Calculating...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Net Worth Charts Section - Full Width Below -->
    <div class="mt-6">
        <div class="card" style="background: rgba(255, 255, 255, 0.05) !important;">
            <div class="px-4 sm:px-6 lg:px-8 py-4 sm:py-6 border-b border-gray-600/30">
                <h2 class="text-lg sm:text-xl font-semibold text-white">Net Worth Charts</h2>
            </div>
            <div class="p-3 sm:p-4 lg:p-6">
                <div class="mb-4 space-y-3">
                    <!-- Chart Type Switcher -->
                    <div class="flex justify-center">
                        <div class="flex bg-gray-700/50 rounded-lg p-1">
                            <button id="lineChartBtnCharts" onclick="switchChartTypeCharts('line')" 
                                    class="px-3 py-1.5 text-xs font-medium rounded-md transition-colors text-gray-300 hover:text-white">
                                <i class="fas fa-chart-line mr-1"></i>Line Chart
                            </button>
                            <button id="barChartBtnCharts" onclick="switchChartTypeCharts('bar')" 
                                    class="px-3 py-1.5 text-xs font-medium rounded-md transition-colors bg-blue-600 text-white">
                                <i class="fas fa-chart-bar mr-1"></i>Stacked Bar
                            </button>
                        </div>
                    </div>
                    
                    <!-- Year Filters -->
                    <div class="flex flex-wrap gap-2 justify-center">
                        <button onclick="filterYearCharts('2023')" class="year-filter-charts px-3 py-1 text-xs rounded-lg bg-gray-600 text-gray-300" data-year="2023">2023</button>
                        <button onclick="filterYearCharts('2024')" class="year-filter-charts px-3 py-1 text-xs rounded-lg bg-gray-600 text-gray-300" data-year="2024">2024</button>
                        <button onclick="filterYearCharts('2025')" class="year-filter-charts px-3 py-1 text-xs rounded-lg bg-blue-600 text-white" data-year="2025">2025</button>
                        <button onclick="filterYearCharts('all')" class="year-filter-charts px-3 py-1 text-xs rounded-lg bg-gray-600 text-gray-300" data-year="all">All Years</button>
                    </div>
                </div>
                <div class="relative h-96 bg-gray-800/50 rounded-xl p-4 privacy-sensitive">
                    <canvas id="networthChartSeparate" width="400" height="300"></canvas>
                </div>
                <div id="chartLoadingSeparate" class="text-center py-8">
                    <i class="fas fa-spinner fa-spin text-gray-400 text-2xl mb-2"></i>
                    <p class="text-gray-400 text-sm">Loading chart data...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Mobile-specific JavaScript
    function updatePriceStatusMobile() {
        fetch('/api/price-status')
            .then(response => response.json())
            .then(data => {
                const statusElement = document.getElementById('price-status-mobile');
                if (statusElement) {
                    if (data.last_updated && data.current_date) {
                        const statusHtml = `
                            <div>Last updated: ${data.current_date}</div>
                            <div>Prices refreshed: ${data.last_updated} (next in ${data.minutes_until_next}m)</div>
                        `;
                        statusElement.innerHTML = statusHtml;
                    } else {
                        statusElement.innerHTML = `
                            <div>Last updated: ${data.current_date || 'Unknown'}</div>
                            <div>Prices refreshed: Never</div>
                        `;
                    }
                }
            })
            .catch(error => {
                console.error('Error fetching mobile price status:', error);
            });
    }

    // Update mobile price status every 30 seconds
    setInterval(updatePriceStatusMobile, 30000);
    
    // Update on page load
    updatePriceStatusMobile();
    
    // Auto-refresh price status every 30 seconds
    function updatePriceStatus() {
        fetch('/api/price-status')
            .then(response => response.json())
            .then(data => {
                const statusElement = document.getElementById('price-status');
                if (statusElement) {
                    if (data.last_updated && data.current_date) {
                        const statusHtml = `
                            <div>Last updated: ${data.current_date}</div>
                            <div>Prices refreshed: ${data.last_updated} (next in ${data.minutes_until_next}m)</div>
                        `;
                        statusElement.innerHTML = statusHtml;
                    } else {
                        statusElement.innerHTML = `
                            <div>Last updated: ${data.current_date || 'Unknown'}</div>
                            <div>Prices refreshed: Never</div>
                        `;
                    }
                }
            })
            .catch(error => {
                console.error('Error fetching price status:', error);
            });
    }

    // Update price status every 30 seconds
    setInterval(updatePriceStatus, 30000);
    
    // Update on page load
    updatePriceStatus();
    
    function refreshPrices() {
        const button = document.querySelector('button[onclick="refreshPrices()"]');
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1 sm:mr-2"></i>Refreshing...';
        button.disabled = true;
        
        fetch('/api/refresh-prices', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Prices refreshed successfully!', 'success');
                    // Reload the page to show updated data
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    showNotification('Failed to refresh prices: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Failed to refresh prices', 'error');
            })
            .finally(() => {
                button.innerHTML = originalText;
                button.disabled = false;
            });
    }
    
    function showNotification(message, type) {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 p-4 rounded-lg text-white z-50 ${
            type === 'success' ? 'bg-green-600' : 'bg-red-600'
        }`;
        notification.textContent = message;
        
        // Add to page
        document.body.appendChild(notification);
        
        // Remove after 3 seconds
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }
    
    // Chart variables
    let currentChartTypeCharts = 'bar';
    let currentYearFilterSeparate = '2025';
    let networthChartSeparate;
    
    // Chart type switching for separate charts section
    function switchChartTypeCharts(type) {
        currentChartTypeCharts = type;
        
        // Update button states
        document.getElementById('lineChartBtnCharts').className = 'px-3 py-1.5 text-xs font-medium rounded-md transition-colors ' + 
            (type === 'line' ? 'bg-blue-600 text-white' : 'text-gray-300 hover:text-white');
        document.getElementById('barChartBtnCharts').className = 'px-3 py-1.5 text-xs font-medium rounded-md transition-colors ' + 
            (type === 'bar' ? 'bg-blue-600 text-white' : 'text-gray-300 hover:text-white');
        
        // Reload chart with new type
        loadChartDataSeparate(currentYearFilterSeparate);
    }
    
    // Year filtering for separate charts
    function filterYearCharts(year) {
        currentYearFilterSeparate = year;
        
        // Update button states
        document.querySelectorAll('.year-filter-charts').forEach(btn => {
            if (btn.dataset.year === year) {
                btn.className = 'year-filter-charts px-3 py-1 text-xs rounded-lg bg-blue-600 text-white';
            } else {
                btn.className = 'year-filter-charts px-3 py-1 text-xs rounded-lg bg-gray-600 text-gray-300';
            }
        });
        
        // Reload chart data
        loadChartDataSeparate(year);
    }
    
    // Load chart data for separate charts section
    function loadChartDataSeparate(year) {
        const chartLoadingElement = document.getElementById('chartLoadingSeparate');
        if (chartLoadingElement) {
            chartLoadingElement.style.display = 'block';
        }
        
        console.log('Loading chart data for year:', year, 'type:', currentChartTypeCharts);
        
        fetch(`/api/networth-chart-data?year=${year}&type=${currentChartTypeCharts}`)
            .then(response => response.json())
            .then(data => {
                console.log('Received chart data:', data);
                if (chartLoadingElement) {
                    chartLoadingElement.style.display = 'none';
                }
                
                const ctx = document.getElementById('networthChartSeparate');
                if (!ctx) return;
                
                // Destroy existing chart
                if (networthChartSeparate) {
                    networthChartSeparate.destroy();
                }
                
                // Handle different data formats
                let chartData;
                if (data.datasets && Array.isArray(data.datasets)) {
                    // Standard chart format with datasets
                    chartData = {
                        labels: data.labels || [],
                        datasets: data.datasets || []
                    };
                } else if (data.values && Array.isArray(data.values)) {
                    // Simple format with just values and labels
                    chartData = {
                        labels: data.labels || [],
                        datasets: [{
                            label: 'Net Worth',
                            data: data.values || [],
                            borderColor: currentChartTypeCharts === 'line' ? '#3b82f6' : 'rgba(59, 130, 246, 0.8)',
                            backgroundColor: currentChartTypeCharts === 'line' ? 'rgba(59, 130, 246, 0.1)' : 'rgba(59, 130, 246, 0.6)',
                            borderWidth: currentChartTypeCharts === 'line' ? 3 : 1,
                            fill: currentChartTypeCharts === 'line',
                            tension: currentChartTypeCharts === 'line' ? 0.4 : 0
                        }]
                    };
                } else {
                    chartData = {
                        labels: [],
                        datasets: []
                    };
                }
                
                console.log('Chart data labels:', chartData.labels);
                console.log('Chart data datasets:', chartData.datasets);
                
                if (chartData.labels.length === 0) {
                    console.warn('No chart labels found');
                }
                if (chartData.datasets.length === 0) {
                    console.warn('No chart datasets found');
                }
                
                const config = {
                    type: currentChartTypeCharts,
                    data: chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { color: '#e5e7eb', boxWidth: 12 }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                backgroundColor: 'rgba(31, 41, 55, 0.95)',
                                titleColor: '#f3f4f6',
                                bodyColor: '#e5e7eb',
                                borderColor: '#6b7280',
                                borderWidth: 1,
                                callbacks: {
                                    footer: function(tooltipItems) {
                                        // Calculate total for the month (for stacked bars, sum all values)
                                        let total = 0;
                                        if (currentChartTypeCharts === 'bar') {
                                            // For stacked bars, show the total across all platforms for this month
                                            tooltipItems.forEach(function(tooltipItem) {
                                                total += tooltipItem.parsed.y;
                                            });
                                        } else {
                                            // For line charts, sum all datasets for this point
                                            const dataIndex = tooltipItems[0].dataIndex;
                                            tooltipItems[0].chart.data.datasets.forEach(function(dataset) {
                                                if (dataset.data[dataIndex]) {
                                                    total += dataset.data[dataIndex];
                                                }
                                            });
                                        }
                                        return 'Total: £' + total.toLocaleString();
                                    },
                                    label: function(context) {
                                        return context.dataset.label + ': £' + context.parsed.y.toLocaleString();
                                    }
                                }
                            }
                        },
                        scales: {
                            x: { 
                                ticks: { color: '#9ca3af' },
                                grid: { color: '#374151' }
                            },
                            y: { 
                                ticks: { 
                                    color: '#9ca3af',
                                    callback: function(value) { return '£' + value.toLocaleString(); }
                                },
                                grid: { color: '#374151' }
                            }
                        }
                    }
                };
                
                if (currentChartTypeCharts === 'bar') {
                    config.options.scales.x.stacked = true;
                    config.options.scales.y.stacked = true;
                }
                
                networthChartSeparate = new Chart(ctx, config);
                console.log('Chart created successfully');
            })
            .catch(error => {
                console.error('Error loading chart data:', error);
                if (chartLoadingElement) {
                    chartLoadingElement.innerHTML = '<p class="text-red-400 text-sm">Error loading chart data</p>';
                }
            });
    }
    
    // Auto-refresh functionality for desktop dashboard
    function startDesktopAutoRefresh() {
        console.log('Starting desktop auto-refresh...');
        
        setInterval(async function() {
            try {
                console.log('Fetching live values for desktop...');
                const response = await fetch('/api/live-values');
                if (response.ok) {
                    const data = await response.json();
                    console.log('Received desktop live data:', data);
                    
                    // Update current net worth
                    const netWorthElement = document.querySelector('.privacy-sensitive p');
                    if (netWorthElement) {
                        const newValue = `£${data.current_net_worth.toLocaleString('en-GB', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                        if (netWorthElement.textContent !== newValue) {
                            netWorthElement.textContent = newValue;
                            console.log('Updated desktop net worth to:', newValue);
                        }
                    }
                    
                    // Update breakdown values in the sidebar
                    const breakdownItems = document.querySelectorAll('.privacy-sensitive');
                    const platformNames = Object.keys(data.platform_allocations);
                    
                    // Find platform amount elements and update them
                    document.querySelectorAll('.privacy-sensitive').forEach(element => {
                        // Look for elements that contain £ amounts
                        if (element.textContent && element.textContent.includes('£') && !element.textContent.includes('%')) {
                            platformNames.forEach(platformName => {
                                // Check if this element corresponds to a platform
                                const parentElement = element.closest('div');
                                if (parentElement && parentElement.textContent.includes(platformName)) {
                                    const newValue = `£${data.platform_allocations[platformName].toLocaleString('en-GB', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                                    if (element.textContent !== newValue) {
                                        element.textContent = newValue;
                                        console.log(`Updated desktop ${platformName} to:`, newValue);
                                    }
                                }
                            });
                        }
                    });
                    
                } else {
                    console.error('Failed to fetch desktop live values:', response.status);
                }
            } catch (error) {
                console.error('Desktop auto-refresh error:', error);
            }
        }, 30000); // Update every 30 seconds
    }
    
    // Mark goal as complete
    function markGoalComplete(goalId) {
        if (confirm('Mark this goal as completed? This will move to the next active goal.')) {
            fetch(`/api/complete-goal/${goalId}`, { 
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Goal marked as completed!', 'success');
                    // Reload to show next goal
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    showNotification('Failed to complete goal: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Failed to complete goal', 'error');
            });
        }
    }
    
    // Compound Interest Prediction Chart
    let millionPredictionChart = null;

    function calculateCompoundInterestData(currentValue, monthlyInvestment, annualRate, targetAmount) {
        const monthlyRate = annualRate / 12 / 100;
        const data = [];
        const milestones = {
            100000: null,
            250000: null,
            500000: null,
            1000000: null
        };
        
        let currentAmount = currentValue;
        let month = 0;
        const today = new Date();
        
        // Add current position
        data.push({
            x: new Date(today),
            y: currentAmount
        });
        
        while (currentAmount < targetAmount && month < 600) { // Max 50 years
            month++;
            // Add monthly investment first, then apply compound interest
            currentAmount = (currentAmount + monthlyInvestment) * (1 + monthlyRate);
            
            const futureDate = new Date(today);
            futureDate.setMonth(futureDate.getMonth() + month);
            
            data.push({
                x: new Date(futureDate),
                y: Math.round(currentAmount)
            });
            
            // Check for milestones
            Object.keys(milestones).forEach(milestone => {
                const target = parseInt(milestone);
                if (milestones[target] === null && currentAmount >= target) {
                    milestones[target] = {
                        date: new Date(futureDate),
                        month: month
                    };
                }
            });
            
            if (currentAmount >= targetAmount) break;
        }
        
        return { data, milestones };
    }

    function createMillionPredictionChart(annualReturn = 10, monthlyInvestment = 1825) {
        const ctx = document.getElementById('millionPredictionChart');
        if (!ctx) return;
        
        // Get current net worth from the page
        const currentNetWorth = {{ current_net_worth }};
        const targetAmount = 1000000;
        
        const prediction = calculateCompoundInterestData(currentNetWorth, monthlyInvestment, annualReturn, targetAmount);
        
        // Destroy existing chart
        if (millionPredictionChart) {
            millionPredictionChart.destroy();
        }
        
        // Create milestone annotations
        const milestoneData = [];
        Object.entries(prediction.milestones).forEach(([amount, info]) => {
            if (info) {
                milestoneData.push({
                    x: info.date,
                    y: parseInt(amount)
                });
            }
        });
        
        // Current position marker
        const currentPositionData = [{
            x: new Date(),
            y: currentNetWorth
        }];
        
        const config = {
            type: 'line',
            data: {
                datasets: [{
                    label: 'Projected Net Worth',
                    data: prediction.data,
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.1,
                    pointRadius: 0,
                    pointHoverRadius: 5
                }, {
                    label: 'Current Position',
                    data: currentPositionData,
                    borderColor: '#10b981',
                    backgroundColor: '#10b981',
                    borderWidth: 0,
                    pointRadius: 8,
                    pointHoverRadius: 10,
                    showLine: false,
                    pointStyle: 'rectRot'
                }, {
                    label: 'Milestones',
                    data: milestoneData,
                    borderColor: '#f59e0b',
                    backgroundColor: '#f59e0b',
                    borderWidth: 0,
                    pointRadius: 6,
                    pointHoverRadius: 10,
                    showLine: false,
                    pointHoverBackgroundColor: '#fbbf24',
                    pointHoverBorderColor: '#f59e0b',
                    pointHoverBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'nearest'
                },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: { 
                            color: '#e5e7eb', 
                            boxWidth: 12,
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(31, 41, 55, 0.95)',
                        titleColor: '#f3f4f6',
                        bodyColor: '#e5e7eb',
                        borderColor: '#6b7280',
                        borderWidth: 1,
                        callbacks: {
                            title: function(tooltipItems) {
                                return tooltipItems[0].parsed.x ? 
                                    new Date(tooltipItems[0].parsed.x).toLocaleDateString('en-GB', { 
                                        year: 'numeric', 
                                        month: 'short' 
                                    }) : '';
                            },
                            label: function(context) {
                                let label = context.dataset.label + ': £' + context.parsed.y.toLocaleString();
                                if (context.dataset.label === 'Current Position') {
                                    label += ' (Today)';
                                } else if (context.dataset.label === 'Milestones') {
                                    const amount = context.parsed.y;
                                    if (amount === 100000) label = '£100k Milestone';
                                    else if (amount === 250000) label = '£250k Milestone';
                                    else if (amount === 500000) label = '£500k Milestone';
                                    else if (amount === 1000000) label = '£1M Milestone';
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'year',
                            displayFormats: {
                                year: 'yyyy'
                            }
                        },
                        min: new Date('2025-01-01'),
                        ticks: { 
                            color: '#9ca3af',
                            maxTicksLimit: 8
                        },
                        grid: { color: '#374151' }
                    },
                    y: {
                        ticks: { 
                            color: '#9ca3af',
                            callback: function(value) { 
                                return '£' + (value / 1000) + 'k'; 
                            }
                        },
                        grid: { color: '#374151' }
                    }
                }
            }
        };
        
        millionPredictionChart = new Chart(ctx, config);
        
        // Store chart reference globally for updates
        window.millionPredictionChart = millionPredictionChart;
        
        // Update milestone dates in the UI
        updateMilestoneDisplay(prediction.milestones);
    }
    
    function updateMilestoneDisplay(milestones) {
        Object.entries(milestones).forEach(([amount, info]) => {
            const elementId = `date-${amount === '100000' ? '100k' : 
                                   amount === '250000' ? '250k' : 
                                   amount === '500000' ? '500k' : '1m'}`;
            const element = document.getElementById(elementId);
            
            if (element && info) {
                const dateStr = info.date.toLocaleDateString('en-GB', { 
                    year: 'numeric', 
                    month: 'short' 
                });
                element.textContent = dateStr;
                
                // Mark as achieved if current net worth is already above this milestone
                const currentNetWorth = {{ current_net_worth }};
                const milestoneParent = element.closest('div');
                if (currentNetWorth >= parseInt(amount)) {
                    milestoneParent.classList.remove('bg-gray-700/30');
                    milestoneParent.classList.add('bg-green-600/20', 'border', 'border-green-500/30');
                    element.textContent = 'Achieved!';
                    element.classList.add('text-green-400');
                }
            } else if (element) {
                element.textContent = 'Beyond projection';
            }
        });
    }

    // Initialize charts when page loads
    document.addEventListener('DOMContentLoaded', function() {
        if (document.getElementById('networthChartSeparate')) {
            loadChartDataSeparate(currentYearFilterSeparate);
        }
        
        if (document.getElementById('millionPredictionChart')) {
            createMillionPredictionChart();
        }
    });
    
    // Prediction settings modal functions
    function openPredictionSettings() {
        document.getElementById('prediction-settings-modal').classList.remove('hidden');
        // Set current values
        document.getElementById('annual-return-input').value = document.getElementById('display-annual-return').textContent;
        document.getElementById('monthly-investment-input').value = document.getElementById('display-monthly-investment').textContent.replace(',', '');
    }
    
    function closePredictionSettings() {
        document.getElementById('prediction-settings-modal').classList.add('hidden');
    }
    
    // Handle prediction settings form submission
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('prediction-settings-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const annualReturn = parseFloat(document.getElementById('annual-return-input').value);
            const monthlyInvestment = parseInt(document.getElementById('monthly-investment-input').value);
            
            // Update display values
            document.getElementById('display-annual-return').textContent = annualReturn;
            document.getElementById('display-monthly-investment').textContent = monthlyInvestment.toLocaleString();
            
            // Recreate the chart with new parameters
            if (window.millionPredictionChart) {
                window.millionPredictionChart.destroy();
            }
            createMillionPredictionChart(annualReturn, monthlyInvestment);
            
            closePredictionSettings();
        });
    });
    
    // Initialize dashboard on page load
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Desktop dashboard initializing...');
        
        // Load initial chart data
        loadChartDataSeparate(currentYearFilterSeparate);
        
        // Create million prediction chart
        createMillionPredictionChart();
        
        // Start auto-refresh for live updates
        startDesktopAutoRefresh();
        
        console.log('Desktop dashboard initialized');
    });
</script>

<!-- Prediction Settings Modal -->
<div id="prediction-settings-modal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
    <div class="liquid-glass-modal max-w-md w-full">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-semibold text-white">Prediction Settings</h3>
            <button onclick="closePredictionSettings()" class="text-gray-400 hover:text-white text-xl">×</button>
        </div>
        
        <form id="prediction-settings-form" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Annual Return (%)</label>
                <input type="number" 
                       id="annual-return-input" 
                       value="10" 
                       step="0.1" 
                       min="0" 
                       max="30"
                       class="w-full px-3 py-2 bg-gray-700/50 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-blue-500 transition-colors">
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Monthly Investment (£)</label>
                <input type="number" 
                       id="monthly-investment-input" 
                       value="1825" 
                       step="25" 
                       min="0" 
                       max="10000"
                       class="w-full px-3 py-2 bg-gray-700/50 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-blue-500 transition-colors">
            </div>
            
            <div class="flex space-x-3 pt-4">
                <button type="button" 
                        onclick="closePredictionSettings()" 
                        class="flex-1 px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">
                    Cancel
                </button>
                <button type="submit" 
                        class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                    Update Chart
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
{% endblock %}