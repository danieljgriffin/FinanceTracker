{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6" style="background: transparent !important;">
    <!-- Desktop Only: Price Status -->
    <div class="hidden md:flex items-center justify-between mb-3 sm:mb-4">
        <h1 class="text-xl sm:text-2xl lg:text-3xl font-bold text-white">Financial Dashboard</h1>
        <div class="text-right">
            <div id="price-status" class="text-xs sm:text-sm text-gray-400">Loading price status...</div>
        </div>
    </div>

    <!-- Mobile Only: Header and Status -->
    <div class="md:hidden mb-3 sm:mb-4">
        <div class="flex flex-col space-y-3">
            <h1 class="text-xl sm:text-2xl font-bold text-white text-center">Financial Dashboard</h1>
            <div class="text-center">
                <div id="price-status-mobile" class="text-xs text-gray-400">Loading...</div>
            </div>
        </div>
    </div>

    <!-- Main Layout: Full Width -->
    <div class="grid grid-cols-1 gap-6" style="background: transparent !important;">

        <!-- Top Row: Net Worth Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- Current Net Worth - Same as Investment Manager "Total Portfolio Value" -->
            <div class="card" style="background: rgba(255, 255, 255, 0.05) !important;">
                <div class="px-4 py-4 border-b border-gray-600/30">
                    <p class="text-xs font-medium text-gray-300 mb-1">Current Net Worth</p>
                    <div class="text-2xl font-bold text-white privacy-sensitive" id="current-net-worth">£{{ "{:,.2f}".format(current_net_worth) }}</div>
                </div>
            </div>

            <!-- Month-on-Month -->
            <div class="card" style="background: rgba(255, 255, 255, 0.05) !important;">
                <div class="px-4 py-4 border-b border-gray-600/30">
                    <p class="text-xs font-medium text-gray-300 mb-1">Month-on-Month</p>
                    <div class="text-2xl font-bold privacy-sensitive {% if mom_change >= 0 %}text-green-500{% else %}text-red-500{% endif %}">
                        {% if mom_change >= 0 %}+{% endif %}£{{ "{:,.0f}".format(mom_amount_change) }} ({{ "{:+.1f}".format(mom_change) }}%)
                    </div>
                </div>
            </div>

            <!-- Yearly Net Worth Increase -->
            <div class="card" style="background: rgba(255, 255, 255, 0.05) !important;">
                <div class="px-4 py-4 border-b border-gray-600/30">
                    <p class="text-xs font-medium text-gray-300 mb-1">Yearly Net Worth Increase</p>
                    <div class="text-2xl font-bold privacy-sensitive {% if yearly_increase >= 0 %}text-green-500{% else %}text-red-500{% endif %}">
                        {% if yearly_increase >= 0 %}+{% endif %}£{{ "{:,.0f}".format(yearly_amount_change) }} ({{ "{:+.1f}".format(yearly_increase) }}%)
                    </div>
                </div>
            </div>
        </div>

        <!-- Second Row: Net Worth Breakdown + Financial Target Progress + £1M Prediction -->
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
            <!-- Left Third: Net Worth Breakdown -->
            <div class="card xl:col-span-1" style="background: rgba(255, 255, 255, 0.05) !important;">
                <div class="px-4 py-4 border-b border-gray-600/30">
                    <h2 class="text-lg font-semibold text-white">Net Worth Breakdown</h2>
                </div>
                <div class="p-4">
                    {% if platform_allocations %}
                        <div class="space-y-4">
                            {% for platform, amount in platform_allocations.items() %}
                                <div class="flex items-center justify-between py-3">
                                    <div class="flex items-center">
                                        <div class="w-4 h-4 rounded-full mr-4 flex-shrink-0" style="background-color: {{ platform_colors.get(platform, '#6b7280') }}"></div>
                                        <div>
                                            <h3 class="font-medium text-white text-base">{{ platform }}</h3>
                                            <p class="text-sm text-gray-400">{{ "{:.1f}".format(platform_percentages.get(platform, 0)) }}% of total</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="font-bold text-white text-lg privacy-sensitive">£{{ "{:,.0f}".format(amount) }}</div>
                                        {% set change_data = platform_monthly_changes.get(platform, {}) %}
                                        {% if change_data.get('previous', 0) > 0 %}
                                            {% set change_amount = change_data.get('amount', 0) %}
                                            {% set change_percent = change_data.get('percent', 0) %}
                                            <div class="mt-0.5">
                                                {% if change_amount > 0 %}
                                                    <span class="inline-flex items-center text-green-500 text-sm font-medium privacy-sensitive">
                                                        <i class="fas fa-arrow-up mr-1"></i>
                                                        +£{{ "{:,.0f}".format(change_amount) }} (+{{ "{:.1f}".format(change_percent) }}%)
                                                    </span>
                                                {% elif change_amount < 0 %}
                                                    <span class="inline-flex items-center text-red-500 text-sm font-medium privacy-sensitive">
                                                        <i class="fas fa-arrow-down mr-1"></i>
                                                        -£{{ "{:,.0f}".format(-change_amount) }} ({{ "{:.1f}".format(change_percent) }}%)
                                                    </span>
                                                {% else %}
                                                    <span class="inline-flex items-center text-gray-400 text-sm">
                                                        <i class="fas fa-minus mr-1"></i>
                                                        No change
                                                    </span>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-8">
                            <i class="fas fa-chart-pie text-gray-400 text-4xl mb-4"></i>
                            <p class="text-gray-400 text-base">No allocation data available</p>
                            <p class="text-sm text-gray-500">Add investments to see net worth allocation</p>
                        </div>
                    {% endif %}
                </div>
            </div>

        <!-- Right Two Thirds: Financial Target Progress + £1M Prediction -->
            <div class="xl:col-span-2 space-y-6">
                <!-- Financial Target Progress -->
                <div class="card" style="background: rgba(255, 255, 255, 0.05) !important;">
                <div class="px-4 sm:px-6 lg:px-8 py-4 sm:py-6 border-b border-gray-600/30">
                    <h2 class="text-lg sm:text-xl font-semibold text-white">
                        Financial Target Progress{% if next_target %} - {{ next_target.target_date.strftime('%b %Y') }} Target{% endif %}
                    </h2>
                </div>
                <div class="p-3 sm:p-4">
                    {% if next_target %}
                    <div class="space-y-4">
                        <!-- Goal Name -->
                        <div class="text-left">
                            <h3 class="text-lg font-medium text-gray-300">{{ next_target.name }}</h3>
                        </div>
                        
                        {% if progress_info %}
                        <!-- Enhanced Progress Bar Section -->
                        <div class="space-y-3">
                            <div class="flex justify-between items-center px-1">
                                <span class="text-gray-300 font-medium text-base">Progress</span>
                                <span class="text-lg font-semibold text-white bg-gray-700/50 px-3 py-1 rounded-full">{{ "{:.1f}".format(progress_info.progress_percentage) }}%</span>
                            </div>
                            
                            <div class="relative">
                                <!-- Progress Bar Container -->
                                <div class="w-full bg-gray-700/50 rounded-xl h-12 relative overflow-hidden">
                                    <!-- Progress Fill with enhanced styling -->
                                    <div class="h-full rounded-xl flex items-center justify-center transition-all duration-1000 shadow-lg" 
                                         style="width: {{ progress_info.progress_percentage }}%; background: linear-gradient(135deg, #60a5fa, #3b82f6, #2563eb) !important;">
                                    </div>
                                    
                                    <!-- Current Net Worth Inside Progress Bar -->
                                    <div class="absolute left-4 top-1/2 transform -translate-y-1/2">
                                        <span class="text-white font-bold text-sm privacy-sensitive">£{{ "{:,.0f}".format(current_net_worth) }}</span>
                                    </div>
                                    
                                    <!-- Target Amount at End -->
                                    <div class="absolute right-4 top-1/2 transform -translate-y-1/2">
                                        <span class="text-gray-200 font-semibold text-sm bg-gray-800/80 px-2 py-1 rounded privacy-sensitive">£{{ "{:,.0f}".format(next_target.target_amount) }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Compact Progress Indicators Below Progress Bar -->
                        <div class="grid grid-cols-2 gap-6">
                            <!-- Days Remaining (Purple) - Compact -->
                            <div class="bg-gradient-to-br from-purple-500/15 to-purple-600/25 rounded-lg p-2 border border-purple-400/20 backdrop-blur-sm">
                                <div class="text-center">
                                    <div class="text-purple-300 text-xs font-medium mb-1 uppercase tracking-wide">Days Remaining</div>
                                    <div class="text-xl font-semibold text-purple-200 privacy-sensitive">
                                        {{ progress_info.days_remaining if progress_info.days_remaining > 0 else 0 }}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Amount Remaining (Blue) - Compact -->
                            <div class="bg-gradient-to-br from-blue-500/15 to-blue-600/25 rounded-lg p-2 border border-blue-400/20 backdrop-blur-sm">
                                <div class="text-center">
                                    <div class="text-blue-300 text-xs font-medium mb-1 uppercase tracking-wide">Amount Remaining</div>
                                    <div class="text-xl font-semibold text-blue-200 privacy-sensitive">
                                        £{{ "{:,.0f}".format(progress_info.remaining_amount) }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Enhanced Action Buttons -->
                        <div class="flex gap-6 pt-1">
                            <!-- View Goals Button -->
                            <a href="{{ url_for('goals') }}" 
                               class="flex-1 flex items-center justify-center py-2 px-4 bg-gradient-to-r from-gray-700/70 to-gray-600/70 hover:from-gray-600/80 hover:to-gray-500/80 rounded-lg transition-all duration-300 border border-gray-500/30 backdrop-blur-sm shadow-lg group">
                                <i class="fas fa-bullseye text-gray-200 mr-2 group-hover:text-white transition-colors"></i>
                                <span class="text-gray-200 font-medium group-hover:text-white transition-colors">View Goals</span>
                            </a>
                            
                            <!-- Complete Goal Button -->
                            <button onclick="markGoalComplete('{{ next_target.id }}')" 
                                    class="px-3 py-2 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-400 hover:to-green-500 rounded-lg transition-all duration-300 border border-green-400/30 shadow-lg transform hover:scale-105 group">
                                <i class="fas fa-check text-white text-lg group-hover:scale-110 transition-transform"></i>
                            </button>
                        </div>
                        
                        <!-- Upcoming Targets Section -->
                        {% if upcoming_targets %}
                        <div class="mt-6 pt-4 border-t border-gray-600/30 privacy-sensitive">
                            <h4 class="text-sm font-semibold text-gray-300 mb-3">
                                <i class="fas fa-clock mr-2 text-blue-400"></i>Upcoming Targets
                            </h4>
                            <div class="space-y-2">
                                {% for target in upcoming_targets %}
                                <div class="flex items-center justify-between p-2 bg-gray-700/30 rounded-lg hover:bg-gray-700/50 transition-colors">
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center space-x-2">
                                            <div class="w-2 h-2 bg-blue-400 rounded-full flex-shrink-0"></div>
                                            <p class="text-sm font-medium text-white truncate">{{ target.title }}</p>
                                        </div>
                                        <p class="text-xs text-gray-400 mt-1">{{ target.target_date.strftime('%b %Y') }}</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-sm font-semibold text-blue-400 privacy-sensitive">£{{ "{:,.0f}".format(target.target_amount) }}</p>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="text-center py-8">
                        <i class="fas fa-bullseye text-gray-500 text-3xl mb-3"></i>
                        <p class="text-gray-400 mb-2">No active financial targets</p>
                        <a href="{{ url_for('goals') }}" class="text-blue-400 hover:text-blue-300 text-sm underline">Set your first goal</a>
                    </div>
                    {% endif %}
                </div>
                </div>

                <!-- £1M Prediction Chart -->
                <div class="card" style="background: rgba(255, 255, 255, 0.05) !important;">
                    <div class="px-4 sm:px-6 lg:px-8 py-4 sm:py-6 border-b border-gray-600/30 flex items-center justify-between">
                        <h2 class="text-lg sm:text-xl font-semibold text-white">£1M Prediction</h2>
                        <div class="flex items-center space-x-2">
                            <button onclick="refreshPrices()" 
                                    class="p-1.5 sm:p-2 bg-gray-700/50 hover:bg-gray-600/50 rounded-lg transition-colors group">
                                <i class="fas fa-cog text-sm group-hover:rotate-90 transition-transform duration-300"></i>
                            </button>
                        </div>
                    </div>
                    <div class="p-3 sm:p-4">
                        <div class="relative h-80 bg-gray-800/50 rounded-xl p-4 privacy-sensitive">
                            <canvas id="millionPredictionChart" width="400" height="300"></canvas>
                        </div>
                        <div id="predictionChartLoading" class="text-center py-8 hidden">
                            <i class="fas fa-spinner fa-spin text-gray-400 text-2xl mb-2"></i>
                            <p class="text-gray-400 text-sm">Loading prediction data...</p>
                        </div>
                        
                        <!-- Key Milestones -->
                        <div class="mt-4 space-y-2 privacy-sensitive">
                            <h3 class="text-sm font-semibold text-gray-300 mb-3">Key Milestones</h3>
                            <div class="grid grid-cols-2 gap-3 text-xs">
                                <div id="milestone-100k" class="flex justify-between p-2 bg-gray-700/30 rounded">
                                    <span class="text-gray-400">£100k:</span>
                                    <span class="text-white" id="date-100k">Calculating...</span>
                                </div>
                                <div id="milestone-250k" class="flex justify-between p-2 bg-gray-700/30 rounded">
                                    <span class="text-gray-400">£250k:</span>
                                    <span class="text-white" id="date-250k">Calculating...</span>
                                </div>
                                <div id="milestone-500k" class="flex justify-between p-2 bg-gray-700/30 rounded">
                                    <span class="text-gray-400">£500k:</span>
                                    <span class="text-white" id="date-500k">Calculating...</span>
                                </div>
                                <div id="milestone-1m" class="flex justify-between p-2 bg-gray-700/30 rounded">
                                    <span class="text-gray-400">£1M:</span>
                                    <span class="text-white" id="date-1m">Calculating...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    <!-- Portfolio Charts Section - Full Width Below -->
    <div class="mt-6">
        <div class="card" style="background: rgba(255, 255, 255, 0.05) !important;">
            <div class="px-4 sm:px-6 lg:px-8 py-4 sm:py-6 border-b border-gray-600/30">
                <h2 class="text-lg sm:text-xl font-semibold text-white">Portfolio Charts</h2>
            </div>
            <div class="p-3 sm:p-4 lg:p-6">
                <!-- Real-Time Progress Line Chart -->
                <div class="mb-8">
                    <div class="flex items-center justify-end mb-4">
                        <div class="flex items-center space-x-3">
                            <div class="flex flex-wrap gap-2">
                                <button id="filter-24h" onclick="switchRealtimeFilter('24h')" 
                                        class="px-2 py-1 text-xs rounded-lg bg-blue-600 text-white transition-colors">
                                    24H
                                </button>
                                <button id="filter-week" onclick="switchRealtimeFilter('week')" 
                                        class="px-2 py-1 text-xs rounded-lg bg-gray-600 hover:bg-gray-500 text-white transition-colors">
                                    Week
                                </button>
                                <button id="filter-month" onclick="switchRealtimeFilter('month')" 
                                        class="px-2 py-1 text-xs rounded-lg bg-gray-600 hover:bg-gray-500 text-white transition-colors">
                                    Month
                                </button>
                                <button id="filter-3months" onclick="switchRealtimeFilter('3months')" 
                                        class="px-2 py-1 text-xs rounded-lg bg-gray-600 hover:bg-gray-500 text-white transition-colors">
                                    3M
                                </button>
                                <button id="filter-year" onclick="switchRealtimeFilter('year')" 
                                        class="px-2 py-1 text-xs rounded-lg bg-gray-600 hover:bg-gray-500 text-white transition-colors">
                                    Year
                                </button>
                                <button id="filter-2023" onclick="switchRealtimeFilter('2023')" 
                                        class="px-2 py-1 text-xs rounded-lg bg-gray-600 hover:bg-gray-500 text-white transition-colors">
                                    2023
                                </button>
                                <button id="filter-2024" onclick="switchRealtimeFilter('2024')" 
                                        class="px-2 py-1 text-xs rounded-lg bg-gray-600 hover:bg-gray-500 text-white transition-colors">
                                    2024
                                </button>
                                <button id="filter-2025" onclick="switchRealtimeFilter('2025')" 
                                        class="px-2 py-1 text-xs rounded-lg bg-gray-600 hover:bg-gray-500 text-white transition-colors">
                                    2025
                                </button>
                                <button id="filter-all-years" onclick="switchRealtimeFilter('all-years')" 
                                        class="px-2 py-1 text-xs rounded-lg bg-gray-600 hover:bg-gray-500 text-white transition-colors">
                                    All
                                </button>
                            </div>

                        </div>
                    </div>
                    <div class="relative h-64 bg-gray-800/50 rounded-xl p-4 privacy-sensitive">
                        <canvas id="realtimeChart" width="400" height="200"></canvas>
                    </div>
                    <div id="realtimeChartLoading" class="text-center py-8">
                        <i class="fas fa-spinner fa-spin text-gray-400 text-2xl mb-2"></i>
                        <p class="text-gray-400 text-sm">Loading real-time data...</p>
                    </div>
                </div>

                <!-- Monthly Breakdown Bar Chart -->
                <div class="border-t border-gray-600/30 pt-6">
                    <div class="flex items-center justify-end mb-4">
                        <div class="flex flex-wrap gap-2">
                            <button onclick="filterYearCharts('2023')" class="year-filter-charts px-3 py-1 text-xs rounded-lg bg-gray-600 hover:bg-gray-500 text-gray-300 transition-colors" data-year="2023">2023</button>
                            <button onclick="filterYearCharts('2024')" class="year-filter-charts px-3 py-1 text-xs rounded-lg bg-gray-600 hover:bg-gray-500 text-gray-300 transition-colors" data-year="2024">2024</button>
                            <button onclick="filterYearCharts('2025')" class="year-filter-charts px-3 py-1 text-xs rounded-lg bg-gray-600 hover:bg-gray-500 text-gray-300 transition-colors" data-year="2025">2025</button>
                            <button onclick="filterYearCharts('all-years')" class="year-filter-charts px-3 py-1 text-xs rounded-lg bg-blue-600 text-white transition-colors" data-year="all-years">All Years</button>
                        </div>
                    </div>
                    <div class="relative h-96 bg-gray-800/50 rounded-xl p-4 privacy-sensitive">
                        <canvas id="networthChartSeparate" width="400" height="300"></canvas>
                    </div>
                    <div id="chartLoadingSeparate" class="text-center py-8">
                        <i class="fas fa-spinner fa-spin text-gray-400 text-2xl mb-2"></i>
                        <p class="text-gray-400 text-sm">Loading chart data...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Price status and refresh functionality
    function updatePriceStatus() {
        fetch('/api/price-status')
            .then(response => response.json())
            .then(data => {
                const statusElement = document.getElementById('price-status');
                const statusElementMobile = document.getElementById('price-status-mobile');
                
                if (statusElement) {
                    if (data.last_updated) {
                        statusElement.innerHTML = `Last updated: ${data.last_updated}`;
                    } else {
                        statusElement.innerHTML = `Last updated: Never`;
                    }
                }
                
                if (statusElementMobile) {
                    if (data.last_updated && data.current_date) {
                        const statusHtml = `
                            <div>Last updated: ${data.current_date}</div>
                            <div>Prices refreshed: ${data.last_updated} (next in ${data.minutes_until_next}m)</div>
                        `;
                        statusElementMobile.innerHTML = statusHtml;
                    } else {
                        statusElementMobile.innerHTML = `
                            <div>Last updated: ${data.current_date || 'Unknown'}</div>
                            <div>Prices refreshed: Never</div>
                        `;
                    }
                }
            })
            .catch(error => {
                console.error('Error fetching price status:', error);
            });
    }

    // Update price status every 30 seconds
    setInterval(updatePriceStatus, 30000);
    updatePriceStatus();
    
    function refreshPrices() {
        const button = document.querySelector('button[onclick="refreshPrices()"]');
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1 sm:mr-2"></i>Refreshing...';
        button.disabled = true;
        
        fetch('/api/refresh-prices', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Prices refreshed successfully!', 'success');
                    // Reload the page to show updated data
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    showNotification('Failed to refresh prices: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Failed to refresh prices', 'error');
            })
            .finally(() => {
                button.innerHTML = originalText;
                button.disabled = false;
            });
    }
    
    function showNotification(message, type) {
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 p-4 rounded-lg text-white z-50 ${
            type === 'success' ? 'bg-green-600' : 'bg-red-600'
        }`;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }
    
    // Chart functionality (without platform allocations)
    let currentYearFilterSeparate = 'all-years';
    let networthChartSeparate;
    
    function filterYearCharts(year) {
        currentYearFilterSeparate = year;
        
        document.querySelectorAll('.year-filter-charts').forEach(btn => {
            if (btn.dataset.year === year) {
                btn.className = 'year-filter-charts px-3 py-1 text-xs rounded-lg bg-blue-600 text-white';
            } else {
                btn.className = 'year-filter-charts px-3 py-1 text-xs rounded-lg bg-gray-600 text-gray-300';
            }
        });
        
        loadChartDataSeparate(year);
    }
    
    function loadChartDataSeparate(filter = 'all-years') {
        const chartLoadingElement = document.getElementById('chartLoadingSeparate');
        const canvasElement = document.getElementById('networthChartSeparate');
        
        if (chartLoadingElement) {
            chartLoadingElement.style.display = 'block';
        }
        if (canvasElement) {
            canvasElement.style.display = 'none';
        }
        
        fetch(`/api/chart-data?filter=${filter}`)
            .then(response => response.json())
            .then(data => {
                if (chartLoadingElement) {
                    chartLoadingElement.style.display = 'none';
                }
                if (canvasElement) {
                    canvasElement.style.display = 'block';
                }
                
                let chartData;
                if (data.datasets && data.datasets.length > 0) {
                    chartData = {
                        labels: data.labels || [],
                        datasets: data.datasets.map(dataset => ({
                            ...dataset,
                            backgroundColor: dataset.backgroundColor || 'rgba(59, 130, 246, 0.6)',
                            borderColor: dataset.borderColor || 'rgba(59, 130, 246, 0.8)',
                            borderWidth: 1
                        }))
                    };
                } else if (data.values && data.labels) {
                    chartData = {
                        labels: data.labels,
                        datasets: [{
                            label: 'Net Worth',
                            data: data.values || [],
                            borderColor: 'rgba(59, 130, 246, 0.8)',
                            backgroundColor: 'rgba(59, 130, 246, 0.6)',
                            borderWidth: 1
                        }]
                    };
                } else {
                    chartData = {
                        labels: [],
                        datasets: []
                    };
                }
                
                if (networthChartSeparate) {
                    networthChartSeparate.destroy();
                }
                
                const ctx = canvasElement.getContext('2d');
                const config = {
                    type: 'bar',
                    data: chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: { color: '#e5e7eb' }
                            }
                        },
                        scales: {
                            x: {
                                stacked: true,
                                ticks: { color: '#9ca3af' },
                                grid: { color: '#374151' }
                            },
                            y: {
                                stacked: true,
                                ticks: { 
                                    color: '#9ca3af',
                                    callback: function(value) { return '£' + value.toLocaleString(); }
                                },
                                grid: { color: '#374151' }
                            }
                        }
                    }
                };
                
                networthChartSeparate = new Chart(ctx, config);
            })
            .catch(error => {
                console.error('Error loading chart data:', error);
                if (chartLoadingElement) {
                    chartLoadingElement.innerHTML = '<p class="text-red-400 text-sm">Error loading chart data</p>';
                }
            });
    }
    
    // Real-time chart functionality
    let realtimeChart;
    let currentRealtimeFilter = '24h';
    
    function loadRealtimeChart(filter = currentRealtimeFilter) {
        const chartLoadingElement = document.getElementById('realtimeChartLoading');
        const canvasElement = document.getElementById('realtimeChart');
        
        if (chartLoadingElement) chartLoadingElement.style.display = 'block';
        if (canvasElement) canvasElement.style.display = 'none';
        
        fetch(`/api/realtime-chart?filter=${filter}`)
            .then(response => response.json())
            .then(data => {
                if (chartLoadingElement) chartLoadingElement.style.display = 'none';
                if (canvasElement) canvasElement.style.display = 'block';
                
                if (realtimeChart) {
                    realtimeChart.destroy();
                }
                
                const ctx = canvasElement.getContext('2d');
                const chartData = {
                    labels: data.labels || [],
                    datasets: [{
                        label: 'Net Worth',
                        data: data.values || [],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                };
                
                realtimeChart = new Chart(ctx, {
                    type: 'line',
                    data: chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#f3f4f6',
                                bodyColor: '#f3f4f6',
                                callbacks: {
                                    label: function(context) {
                                        return 'Net Worth: £' + context.parsed.y.toLocaleString();
                                    }
                                }
                            }
                        },
                        scales: {
                            x: { 
                                ticks: { color: '#9ca3af', font: { size: 10 } },
                                grid: { color: '#374151' }
                            },
                            y: { 
                                ticks: { 
                                    color: '#9ca3af',
                                    font: { size: 10 },
                                    callback: function(value) { return '£' + value.toLocaleString(); }
                                },
                                grid: { color: '#374151' }
                            }
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Error loading realtime chart:', error);
            });
    }
    
    function switchRealtimeFilter(filter) {
        currentRealtimeFilter = filter;
        
        document.querySelectorAll('[id^="filter-"]').forEach(btn => {
            if (btn.id === `filter-${filter}`) {
                btn.className = btn.className.replace('bg-gray-600', 'bg-blue-600');
            } else {
                btn.className = btn.className.replace('bg-blue-600', 'bg-gray-600');
            }
        });
        
        loadRealtimeChart(filter);
    }
    
    // £1M Prediction Chart
    function loadMillionPredictionChart() {
        const canvasElement = document.getElementById('millionPredictionChart');
        if (!canvasElement) return;
        
        fetch('/api/million-prediction')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error loading prediction data:', data.error);
                    return;
                }
                
                const ctx = canvasElement.getContext('2d');
                
                // Prepare milestone data
                const milestones = [
                    { value: 100000, label: '£100k', color: '#10b981' },
                    { value: 250000, label: '£250k', color: '#3b82f6' },
                    { value: 500000, label: '£500k', color: '#8b5cf6' },
                    { value: 1000000, label: '£1M', color: '#f59e0b' }
                ];
                
                const milestoneData = milestones.map(milestone => {
                    const date = data.milestones && data.milestones[milestone.value];
                    return {
                        x: date || null,
                        y: milestone.value,
                        label: milestone.label,
                        color: milestone.color
                    };
                }).filter(point => point.x !== null);
                
                // Current position data
                const currentPositionData = [{
                    x: data.current_date,
                    y: data.current_net_worth,
                    label: 'Current Position'
                }];
                
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: 'Projected Net Worth',
                            data: data.prediction?.data || [],
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.1,
                            pointRadius: 0,
                            pointHoverRadius: 5
                        }, {
                            label: 'Current Position',
                            data: currentPositionData,
                            borderColor: '#10b981',
                            backgroundColor: '#10b981',
                            borderWidth: 0,
                            pointRadius: 8,
                            pointHoverRadius: 10,
                            showLine: false,
                            pointStyle: 'rectRot'
                        }, {
                            label: 'Milestones',
                            data: milestoneData,
                            borderColor: '#f59e0b',
                            backgroundColor: milestoneData.map(point => point.color),
                            borderWidth: 0,
                            pointRadius: 6,
                            pointHoverRadius: 8,
                            showLine: false,
                            pointStyle: 'star'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: { color: '#e5e7eb' }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#f3f4f6',
                                bodyColor: '#f3f4f6'
                            }
                        },
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'month',
                                    displayFormats: { month: 'MMM yyyy' }
                                },
                                ticks: { color: '#9ca3af' },
                                grid: { color: '#374151' }
                            },
                            y: {
                                ticks: {
                                    color: '#9ca3af',
                                    callback: function(value) {
                                        if (value >= 1000000) return '£' + (value / 1000000).toFixed(1) + 'M';
                                        if (value >= 1000) return '£' + (value / 1000).toFixed(0) + 'k';
                                        return '£' + value.toLocaleString();
                                    }
                                },
                                grid: { color: '#374151' }
                            }
                        }
                    }
                });
                
                // Update milestone dates
                if (data.milestones) {
                    Object.keys(data.milestones).forEach(milestone => {
                        const elementId = milestone === '100000' ? 'date-100k' :
                                        milestone === '250000' ? 'date-250k' :
                                        milestone === '500000' ? 'date-500k' :
                                        milestone === '1000000' ? 'date-1m' : null;
                        
                        if (elementId) {
                            const element = document.getElementById(elementId);
                            if (element) {
                                element.textContent = new Date(data.milestones[milestone]).toLocaleDateString('en-GB', {
                                    month: 'short',
                                    year: 'numeric'
                                });
                            }
                        }
                    });
                }
            })
            .catch(error => {
                console.error('Error loading million prediction chart:', error);
            });
    }
    
    function markGoalComplete(goalId) {
        if (!confirm('Mark this goal as complete?')) return;
        
        fetch('/api/complete-goal', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ goal_id: goalId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Goal marked as complete!', 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showNotification('Failed to complete goal: ' + (data.error || 'Unknown error'), 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Failed to complete goal', 'error');
        });
    }
    
    // Load all charts when page loads
    document.addEventListener('DOMContentLoaded', function() {
        loadChartDataSeparate();
        loadRealtimeChart();
        loadMillionPredictionChart();
    });
</script>
{% endblock %}