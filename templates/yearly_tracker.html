{% extends "base.html" %}

{% block title %}Yearly Tracker - Net Worth Tracker{% endblock %}

{% block content %}
<style>
    .shadow-r {
        box-shadow: 2px 0 4px rgba(0, 0, 0, 0.1);
    }
</style>

<div class="space-y-6">
    <!-- Header with Year Selection -->
    <div class="card">
        <div class="px-8 py-6">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl font-bold text-gray-900">Yearly Tracker</h1>
                <div class="flex items-center space-x-4">
                    <!-- Year Navigation -->
                    <div class="flex items-center space-x-2">
                        <label class="text-sm font-medium text-gray-700">Year:</label>
                        <select id="yearSelect" class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="changeYear(this.value)">
                            {% for year in available_years %}
                                <option value="{{ year }}" {% if year == current_year %}selected{% endif %}>{{ year }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Add New Year Button -->
                    <button onclick="toggleNewYearForm()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                        <i class="fas fa-plus mr-2"></i>Add Year
                    </button>
                    
                    <!-- Auto-populate Button (Only for 2025) -->
                    {% if current_year == 2025 %}
                        <button onclick="autoPopulateMonth()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                            <i class="fas fa-magic mr-2"></i>Auto-populate Current Month
                        </button>
                    {% endif %}
                </div>
            </div>
            
            <!-- New Year Form (Hidden by default) -->
            <div id="newYearForm" class="hidden mt-4 p-4 bg-gray-50 rounded-lg">
                <form method="POST" action="{{ url_for('create_year') }}" class="flex items-center space-x-4">
                    <label class="text-sm font-medium text-gray-700">New Year:</label>
                    <input type="number" name="year" min="2020" max="2030" class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="2026" required>
                    <button type="submit" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                        Create
                    </button>
                    <button type="button" onclick="toggleNewYearForm()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                        Cancel
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Monthly Tracker Table -->
    <div class="card">
        <div class="px-8 py-6 border-b border-gray-200">
            <h2 class="text-xl font-semibold text-gray-900">{{ current_year }} Monthly Net Worth Tracking</h2>
            <p class="text-sm text-gray-600 mt-1">Track platform values on the 1st of each month and 31st December</p>
        </div>
        
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky left-0 bg-gray-50 z-10">
                            Platform
                        </th>
                        {% for month in months %}
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider min-w-24">
                                {{ month }}
                            </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for platform in platforms %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap sticky left-0 bg-white z-10 shadow-r">
                                <div class="flex items-center">
                                    <div class="w-3 h-3 rounded-full mr-3" style="background-color: {{ platform.color }}"></div>
                                    <div class="text-sm font-medium text-gray-900">{{ platform.name }}</div>
                                </div>
                            </td>
                            {% for month in months %}
                                <td class="px-4 py-4 whitespace-nowrap text-center">
                                    <div class="relative">
                                        <input type="number" 
                                               step="0.01"
                                               value="{{ networth_data.get(month, {}).get(platform.name, '') }}"
                                               class="w-20 px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 text-center"
                                               placeholder="0.00"
                                               onchange="updateValue('{{ current_year }}', '{{ month }}', '{{ platform.name }}', this.value)">
                                    </div>
                                </td>
                            {% endfor %}
                        </tr>
                    {% endfor %}
                    
                    <!-- Total Row -->
                    <tr class="bg-gray-100 font-semibold border-t-2 border-gray-300">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900 sticky left-0 bg-gray-100 z-10 shadow-r">
                            Total Net Worth
                        </td>
                        {% for month in months %}
                            <td class="px-4 py-4 whitespace-nowrap text-center">
                                <div class="text-sm font-bold text-gray-900">
                                    {% set total = networth_data.get(month, {}).get('total_net_worth', 0) %}
                                    {% if total > 0 %}
                                        Â£{{ "{:,.0f}".format(total) }}
                                    {% else %}
                                        <span class="text-gray-400">-</span>
                                    {% endif %}
                                </div>
                            </td>
                        {% endfor %}
                    </tr>
                    
                    <!-- Month-on-Month Change Row -->
                    <tr class="bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-700 sticky left-0 bg-gray-50 z-10 shadow-r">
                            Month-on-Month Change
                        </td>
                        {% set previous_total = 0 %}
                        {% for month in months %}
                            <td class="px-4 py-4 whitespace-nowrap text-center">
                                {% set current_total = networth_data.get(month, {}).get('total_net_worth', 0) %}
                                {% if current_total > 0 and previous_total > 0 %}
                                    {% set change_percent = ((current_total - previous_total) / previous_total) * 100 %}
                                    <div class="text-sm font-medium {{ 'text-green-600' if change_percent > 0 else 'text-red-600' if change_percent < 0 else 'text-gray-500' }}">
                                        {{ "{:+.1f}".format(change_percent) }}%
                                    </div>
                                {% else %}
                                    <span class="text-gray-400">-</span>
                                {% endif %}
                                {% set previous_total = current_total if current_total > 0 else previous_total %}
                            </td>
                        {% endfor %}
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
function changeYear(year) {
    window.location.href = `/yearly-tracker/${year}`;
}

function toggleNewYearForm() {
    const form = document.getElementById('newYearForm');
    form.classList.toggle('hidden');
}

function updateValue(year, month, platform, value) {
    if (value === '') {
        value = 0;
    }
    
    // Create a form and submit it
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{{ url_for("update_monthly_value") }}';
    
    // Add form fields
    const fields = [
        { name: 'year', value: year },
        { name: 'month', value: month },
        { name: 'platform', value: platform },
        { name: 'value', value: value }
    ];
    
    fields.forEach(field => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = field.name;
        input.value = field.value;
        form.appendChild(input);
    });
    
    document.body.appendChild(form);
    form.submit();
}

function autoPopulateMonth() {
    // Create a form and submit it
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{{ url_for("auto_populate_month") }}';
    
    // Add year field
    const yearInput = document.createElement('input');
    yearInput.type = 'hidden';
    yearInput.name = 'year';
    yearInput.value = '{{ current_year }}';
    form.appendChild(yearInput);
    
    document.body.appendChild(form);
    form.submit();
}

// Auto-save functionality (optional enhancement)
document.addEventListener('DOMContentLoaded', function() {
    const inputs = document.querySelectorAll('input[type="number"]');
    inputs.forEach(input => {
        input.addEventListener('blur', function() {
            // Could implement auto-save here
        });
    });
});
</script>
{% endblock %}