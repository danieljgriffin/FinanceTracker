{% extends "base.html" %}

{% block title %}Yearly Tracker - Net Worth Tracker{% endblock %}

{% block content %}
<style>
    .shadow-r {
        box-shadow: 2px 0 4px rgba(0, 0, 0, 0.1);
    }
</style>

<div class="space-y-6">
    <!-- Header with Year Selection -->
    <div class="card">
        <div class="px-8 py-6">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl font-bold text-white">Yearly Tracker</h1>
                <div class="flex items-center space-x-4">
                    <!-- Year Navigation -->
                    <div class="flex items-center space-x-2">
                        <label class="text-sm font-medium text-white">Year:</label>
                        <select id="yearSelect" class="border border-gray-600 bg-gray-800 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="changeYear(this.value)">
                            {% for year in available_years %}
                                <option value="{{ year }}" {% if year == current_year %}selected{% endif %}>{{ year }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Add New Year Button -->
                    <button onclick="toggleNewYearForm()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                        <i class="fas fa-plus mr-2"></i>Add Year
                    </button>
                    
                    <!-- Edit/Save Button -->
                    <button id="editSaveBtn" onclick="toggleEditMode()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                        <i class="fas fa-edit mr-2"></i>Edit
                    </button>
                    
                    <!-- Auto-populate Button (Only for 2025) -->
                    {% if current_year == 2025 %}
                        <button onclick="autoPopulateMonth()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                            <i class="fas fa-magic mr-2"></i>Auto-populate Current Month
                        </button>
                    {% endif %}
                </div>
            </div>
            
            <!-- New Year Form (Hidden by default) -->
            <div id="newYearForm" class="hidden mt-4 p-4 bg-gray-800 rounded-lg">
                <form method="POST" action="{{ url_for('create_year') }}" class="flex items-center space-x-4">
                    <label class="text-sm font-medium text-white">New Year:</label>
                    <input type="number" name="year" min="2020" max="2030" class="border border-gray-600 bg-gray-700 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="2026" required>
                    <button type="submit" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                        Create
                    </button>
                    <button type="button" onclick="toggleNewYearForm()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                        Cancel
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Monthly Tracker Table -->
    <div class="card">
        <div class="px-8 py-6 border-b border-gray-600/30">
            <div class="flex justify-between items-center">
                <div>
                    <h2 class="text-xl font-semibold text-white">{{ current_year }} Monthly Net Worth Tracking</h2>
                    <p class="text-sm text-gray-400 mt-1">Track platform values on the 1st of each month and 31st December</p>
                </div>
                <div class="text-right">
                    <div class="text-sm text-gray-400">Yearly Net Worth Increase</div>
                    <div class="text-lg font-semibold {{ 'text-green-600' if yearly_increase_percent > 0 else 'text-red-600' if yearly_increase_percent < 0 else 'text-gray-500' }}">
                        {{ "{:+.1f}".format(yearly_increase_percent) }}%
                    </div>
                </div>
            </div>
        </div>
        
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-600/30">
                <thead class="bg-gray-800/50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider sticky left-0 bg-gray-800/50 z-10">
                            Platform
                        </th>
                        {% for month in months %}
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-300 uppercase tracking-wider min-w-24">
                                {{ month }}
                            </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-600/30">
                    {% for platform in platforms %}
                        <tr class="hover:bg-gray-800/30">
                            <td class="px-6 py-4 whitespace-nowrap sticky left-0 bg-gray-900/50 z-10 shadow-r">
                                <div class="flex items-center">
                                    <div class="w-3 h-3 rounded-full mr-3" style="background-color: {{ platform.color }}"></div>
                                    <div class="text-sm font-medium text-white">{{ platform.name }}</div>
                                </div>
                            </td>
                            {% for month in months %}
                                <td class="px-4 py-4 whitespace-nowrap text-center">
                                    <div class="relative">
                                        <input type="number" 
                                               step="0.01"
                                               value="{{ networth_data.get(month, {}).get(platform.name, '') }}"
                                               class="w-32 px-3 py-2 text-sm border border-gray-600 bg-gray-700 text-white rounded-lg focus:outline-none focus:ring-1 focus:ring-blue-500 text-center value-input disabled:bg-gray-800 disabled:text-gray-300"
                                               placeholder="0.00"
                                               data-year="{{ current_year }}"
                                               data-month="{{ month }}"
                                               data-platform="{{ platform.name }}"
                                               disabled>
                                    </div>
                                </td>
                            {% endfor %}
                        </tr>
                    {% endfor %}
                    
                    <!-- Total Row -->
                    <tr class="bg-gray-800/50 font-semibold border-t-2 border-gray-600/50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-white sticky left-0 bg-gray-800/50 z-10 shadow-r">
                            Total Net Worth
                        </td>
                        {% for month in months %}
                            <td class="px-4 py-4 whitespace-nowrap text-center">
                                <div class="text-sm font-bold text-white">
                                    {% set total = monthly_totals.get(month, 0) %}
                                    {% if total > 0 %}
                                        £{{ "{:,.0f}".format(total) }}
                                    {% else %}
                                        <span class="text-gray-400">-</span>
                                    {% endif %}
                                </div>
                            </td>
                        {% endfor %}
                    </tr>
                    
                    <!-- Month-on-Month Change Row -->
                    <tr class="bg-gray-800/30">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-300 sticky left-0 bg-gray-800/30 z-10 shadow-r">
                            Month-on-Month Change
                        </td>
                        {% for month in months %}
                            <td class="px-4 py-4 whitespace-nowrap text-center">
                                {% set change_percent = monthly_changes.get(month) %}
                                {% if change_percent is not none %}
                                    <div class="text-sm font-medium {{ 'text-green-600' if change_percent > 0 else 'text-red-600' if change_percent < 0 else 'text-gray-500' }}">
                                        {{ "{:+.1f}".format(change_percent) }}%
                                    </div>
                                {% else %}
                                    <span class="text-gray-400">-</span>
                                {% endif %}
                            </td>
                        {% endfor %}
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Income vs Investments Table -->
<div class="card mt-8">
    <div class="px-8 py-6 border-b border-gray-600/30">
        <div class="flex justify-between items-center">
            <div>
                <h2 class="text-xl font-semibold text-white">Income vs Investments Overview</h2>
                <p class="text-sm text-gray-400 mt-1">Track yearly take-home income and investment amounts</p>
            </div>
            <button id="editSaveIncomeBtn" onclick="toggleIncomeEditMode()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                <i class="fas fa-edit mr-2"></i>Edit
            </button>
        </div>
    </div>
    
    <div class="p-8 overflow-x-auto">
        <table class="w-full">
            <thead>
                <tr class="border-b border-gray-600/30">
                    <th class="text-left text-white font-semibold py-3">Year</th>
                    <th class="text-right text-white font-semibold py-3">Take Home Income</th>
                    <th class="text-right text-white font-semibold py-3">Invested</th>
                    <th class="text-right text-white font-semibold py-3">% Invested</th>
                </tr>
            </thead>
            <tbody>
                <!-- Sep-Dec 2017 -->
                <tr class="border-b border-gray-600/20">
                    <td class="py-3 text-white">Sep-Dec 2017</td>
                    <td class="py-3 text-right">
                        <div class="flex items-center justify-end">
                            <span class="text-gray-400 mr-1">£</span>
                            <input type="number" 
                                   class="income-input w-32 text-right bg-gray-800 text-gray-300 border-none focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg px-3 py-2" 
                                   data-year="2017" 
                                   data-field="take_home_income" 
                                   value="{{ income_data.get('2017', {}).get('take_home_income', 0) }}"
                                   step="1" />
                        </div>
                    </td>
                    <td class="py-3 text-right">
                        <div class="flex items-center justify-end">
                            <span class="text-gray-400 mr-1">£</span>
                            <input type="number" 
                                   class="income-input w-32 text-right bg-gray-800 text-gray-300 border-none focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg px-3 py-2" 
                                   data-year="2017" 
                                   data-field="amount_invested" 
                                   value="{{ income_data.get('2017', {}).get('amount_invested', 0) }}"
                                   step="1" />
                        </div>
                    </td>
                    <td class="py-3 text-right">
                        <span class="text-gray-300 income-percentage" data-year="2017">
                            {% set income_2017 = income_data.get('2017', {}).get('take_home_income', 0) %}
                            {% set invested_2017 = income_data.get('2017', {}).get('amount_invested', 0) %}
                            {% if income_2017 > 0 %}
                                {{ "{:.1f}".format((invested_2017 / income_2017) * 100) }}%
                            {% else %}
                                0.0%
                            {% endif %}
                        </span>
                    </td>
                </tr>
                
                <!-- Years 2018-2030 -->
                {% for year in range(2018, 2031) %}
                <tr class="border-b border-gray-600/20">
                    <td class="py-3 text-white">{{ year }}</td>
                    <td class="py-3 text-right">
                        <div class="flex items-center justify-end">
                            <span class="text-gray-400 mr-1">£</span>
                            <input type="number" 
                                   class="income-input w-32 text-right bg-gray-800 text-gray-300 border-none focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg px-3 py-2" 
                                   data-year="{{ year }}" 
                                   data-field="take_home_income" 
                                   value="{{ income_data.get(year|string, {}).get('take_home_income', 0) }}"
                                   step="1" />
                        </div>
                    </td>
                    <td class="py-3 text-right">
                        <div class="flex items-center justify-end">
                            <span class="text-gray-400 mr-1">£</span>
                            <input type="number" 
                                   class="income-input w-32 text-right bg-gray-800 text-gray-300 border-none focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg px-3 py-2" 
                                   data-year="{{ year }}" 
                                   data-field="amount_invested" 
                                   value="{{ income_data.get(year|string, {}).get('amount_invested', 0) }}"
                                   step="1" />
                        </div>
                    </td>
                    <td class="py-3 text-right">
                        <span class="text-gray-300 income-percentage" data-year="{{ year }}">
                            {% set income_year = income_data.get(year|string, {}).get('take_home_income', 0) %}
                            {% set invested_year = income_data.get(year|string, {}).get('amount_invested', 0) %}
                            {% if income_year > 0 %}
                                {{ "{:.1f}".format((invested_year / income_year) * 100) }}%
                            {% else %}
                                0.0%
                            {% endif %}
                        </span>
                    </td>
                </tr>
                {% endfor %}
                
                <!-- Totals Row -->
                <tr class="border-t-2 border-gray-600/50 bg-gray-800/30">
                    <td class="py-4 text-white font-bold">Total</td>
                    <td class="py-4 text-right">
                        <div class="text-lg font-bold text-green-400" id="total-income">
                            {% set total_income = 0 %}
                            {% for year in range(2017, 2031) %}
                                {% set year_income = income_data.get(year|string, {}).get('take_home_income', 0) %}
                                {% set total_income = total_income + year_income %}
                            {% endfor %}
                            £{{ "{:,.2f}".format(total_income) }}
                        </div>
                    </td>
                    <td class="py-4 text-right">
                        <div class="text-lg font-bold text-blue-400" id="total-invested">
                            {% set total_invested = 0 %}
                            {% for year in range(2017, 2031) %}
                                {% set year_invested = income_data.get(year|string, {}).get('amount_invested', 0) %}
                                {% set total_invested = total_invested + year_invested %}
                            {% endfor %}
                            £{{ "{:,.2f}".format(total_invested) }}
                        </div>
                    </td>
                    <td class="py-4 text-right">
                        <div class="text-lg font-bold text-purple-400" id="total-percentage">
                            {% if total_income > 0 %}
                                {{ "{:.1f}".format((total_invested / total_income) * 100) }}%
                            {% else %}
                                0.0%
                            {% endif %}
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
function changeYear(year) {
    window.location.href = `/yearly-tracker/${year}`;
}

function toggleNewYearForm() {
    const form = document.getElementById('newYearForm');
    form.classList.toggle('hidden');
}

let isEditMode = false;
let isIncomeEditMode = false;
let originalValues = {};
let originalIncomeValues = {};

function toggleEditMode() {
    const editBtn = document.getElementById('editSaveBtn');
    const inputs = document.querySelectorAll('.value-input');
    
    if (!isEditMode) {
        // Enter edit mode
        isEditMode = true;
        editBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Save';
        editBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
        editBtn.classList.add('bg-green-500', 'hover:bg-green-600');
        
        // Store original values and enable inputs
        inputs.forEach(input => {
            originalValues[input.dataset.year + '-' + input.dataset.month + '-' + input.dataset.platform] = input.value;
            input.disabled = false;
            input.classList.remove('bg-gray-800', 'text-gray-300');
            input.classList.add('bg-gray-700', 'text-white');
        });
        
    } else {
        // Save mode - collect all changes and submit
        const changes = [];
        inputs.forEach(input => {
            const key = input.dataset.year + '-' + input.dataset.month + '-' + input.dataset.platform;
            if (input.value !== originalValues[key]) {
                changes.push({
                    year: input.dataset.year,
                    month: input.dataset.month,
                    platform: input.dataset.platform,
                    value: input.value || 0
                });
            }
        });
        
        if (changes.length > 0) {
            saveAllChanges(changes);
        } else {
            // No changes, just exit edit mode
            exitEditMode();
        }
    }
}

function saveAllChanges(changes) {
    // Create a form and submit all changes
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{{ url_for("update_monthly_value") }}';
    
    // Add changes as JSON
    const changesInput = document.createElement('input');
    changesInput.type = 'hidden';
    changesInput.name = 'changes';
    changesInput.value = JSON.stringify(changes);
    form.appendChild(changesInput);
    
    document.body.appendChild(form);
    form.submit();
}

function exitEditMode() {
    isEditMode = false;
    const editBtn = document.getElementById('editSaveBtn');
    const inputs = document.querySelectorAll('.value-input');
    
    editBtn.innerHTML = '<i class="fas fa-edit mr-2"></i>Edit';
    editBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
    editBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
    
    inputs.forEach(input => {
        input.disabled = true;
        input.classList.remove('bg-gray-700', 'text-white');
        input.classList.add('bg-gray-800', 'text-gray-300');
    });
    
    originalValues = {};
}

function autoPopulateMonth() {
    // Create a form and submit it
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{{ url_for("auto_populate_month") }}';
    
    // Add year field
    const yearInput = document.createElement('input');
    yearInput.type = 'hidden';
    yearInput.name = 'year';
    yearInput.value = '{{ current_year }}';
    form.appendChild(yearInput);
    
    document.body.appendChild(form);
    form.submit();
}

function toggleIncomeEditMode() {
    const editBtn = document.getElementById('editSaveIncomeBtn');
    const inputs = document.querySelectorAll('.income-input');
    
    if (!isIncomeEditMode) {
        // Enter edit mode
        isIncomeEditMode = true;
        editBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Save';
        editBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
        editBtn.classList.add('bg-green-500', 'hover:bg-green-600');
        
        // Store original values and enable inputs
        inputs.forEach(input => {
            originalIncomeValues[input.dataset.year + '-' + input.dataset.field] = input.value;
            input.disabled = false;
            input.classList.remove('bg-gray-800', 'text-gray-300');
            input.classList.add('bg-gray-700', 'text-white');
        });
        
    } else {
        // Save mode - collect all changes and submit
        const changes = [];
        inputs.forEach(input => {
            const key = input.dataset.year + '-' + input.dataset.field;
            if (input.value !== originalIncomeValues[key]) {
                changes.push({
                    year: input.dataset.year,
                    field: input.dataset.field,
                    value: input.value || 0
                });
            }
        });
        
        if (changes.length > 0) {
            saveIncomeChanges(changes);
        } else {
            // No changes, just exit edit mode
            exitIncomeEditMode();
        }
    }
}

function saveIncomeChanges(changes) {
    // Create a form and submit all changes
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/update-income-data';
    
    // Add changes as JSON
    const changesInput = document.createElement('input');
    changesInput.type = 'hidden';
    changesInput.name = 'changes';
    changesInput.value = JSON.stringify(changes);
    form.appendChild(changesInput);
    
    document.body.appendChild(form);
    form.submit();
}

function updateIncomePercentage(year) {
    const incomeInput = document.querySelector(`input[data-year="${year}"][data-field="take_home_income"]`);
    const investedInput = document.querySelector(`input[data-year="${year}"][data-field="amount_invested"]`);
    const percentageSpan = document.querySelector(`.income-percentage[data-year="${year}"]`);
    
    if (incomeInput && investedInput && percentageSpan) {
        const income = parseFloat(incomeInput.value) || 0;
        const invested = parseFloat(investedInput.value) || 0;
        const percentage = income > 0 ? (invested / income) * 100 : 0;
        percentageSpan.textContent = `${percentage.toFixed(1)}%`;
    }
}

function updateTotals() {
    const incomeInputs = document.querySelectorAll('input[data-field="take_home_income"]');
    const investedInputs = document.querySelectorAll('input[data-field="amount_invested"]');
    
    let totalIncome = 0;
    let totalInvested = 0;
    
    incomeInputs.forEach(input => {
        totalIncome += parseFloat(input.value) || 0;
    });
    
    investedInputs.forEach(input => {
        totalInvested += parseFloat(input.value) || 0;
    });
    
    const totalPercentage = totalIncome > 0 ? (totalInvested / totalIncome) * 100 : 0;
    
    document.getElementById('total-income').textContent = `£${totalIncome.toLocaleString('en-GB', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
    document.getElementById('total-invested').textContent = `£${totalInvested.toLocaleString('en-GB', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
    document.getElementById('total-percentage').textContent = `${totalPercentage.toFixed(1)}%`;
}

// Add event listeners for real-time updates
document.addEventListener('DOMContentLoaded', function() {
    // Existing code...
    
    // Add event listeners to income inputs for real-time updates
    const incomeInputs = document.querySelectorAll('.income-input');
    incomeInputs.forEach(input => {
        input.addEventListener('input', function() {
            const year = this.dataset.year;
            updateIncomePercentage(year);
            updateTotals();
        });
    });
});

function exitIncomeEditMode() {
    isIncomeEditMode = false;
    const editBtn = document.getElementById('editSaveIncomeBtn');
    const inputs = document.querySelectorAll('.income-input');
    
    editBtn.innerHTML = '<i class="fas fa-edit mr-2"></i>Edit';
    editBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
    editBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
    
    inputs.forEach(input => {
        input.disabled = true;
        input.classList.remove('bg-gray-700', 'text-white');
        input.classList.add('bg-gray-800', 'text-gray-300');
    });
    
    originalIncomeValues = {};
}

// Initialize disabled state
document.addEventListener('DOMContentLoaded', function() {
    const inputs = document.querySelectorAll('.value-input');
    inputs.forEach(input => {
        input.disabled = true;
        input.classList.add('bg-gray-800', 'text-gray-300');
    });
    
    // Initialize income inputs as disabled
    const incomeInputs = document.querySelectorAll('.income-input');
    incomeInputs.forEach(input => {
        input.disabled = true;
        input.classList.add('bg-gray-800', 'text-gray-300');
    });
});
</script>
{% endblock %}